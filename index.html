<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crusade Tracker</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e1e2f 0%, #2a2a3e 100%);
            color: white;
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        .header {
            background: linear-gradient(135deg, #2a2a3e 0%, #1e1e2f 100%);
            border-bottom: 2px solid #ffd700;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            color: #ffd700;
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .header-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .tabs {
            background: #2a2a3e;
            border-bottom: 1px solid #444;
            display: flex;
            overflow-x: auto;
            position: sticky;
            top: 73px;
            z-index: 99;
        }
        
        .tab {
            flex: 1;
            min-width: 120px;
            padding: 1rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: #ccc;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .tab:hover {
            background: rgba(255, 215, 0, 0.1);
            color: #ffd700;
        }
        
        .tab.active {
            color: #ffd700;
            border-bottom-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
            font-weight: bold;
        }
        
        .content {
            padding: 1rem;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card {
            background: linear-gradient(135deg, #2a2a3e 0%, #1a1a2e 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            border: 1px solid #444;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.5);
        }
        
        .card h2 {
            color: #ffd700;
            font-size: 1.25rem;
            margin-bottom: 1rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .unit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1rem;
        }
        
        .unit-card {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            border-radius: 12px;
            padding: 1.25rem;
            border: 2px solid #444;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .unit-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .unit-card:hover {
            border-color: #ffd700;
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(255, 215, 0, 0.2);
        }
        
        .unit-card.selected {
            border-color: #ffd700;
            box-shadow: 0 0 32px rgba(255, 215, 0, 0.4);
            background: linear-gradient(135deg, #2a2a3e 0%, #1a1a2e 100%);
        }
        
        .unit-card.selected::before {
            transform: scaleX(1);
        }

        .unit-card.destroyed {
            opacity: 0.5;
            filter: grayscale(80%);
            border-color: #666;
            text-decoration: line-through;
            cursor: default;
        }
        
        .unit-name {
            color: #ffd700;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .unit-faction {
            color: #aaa;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            font-style: italic;
        }
        
        .unit-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #ccc;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }
        
        .stat-label {
            color: #999;
        }
        
        .stat-value {
            color: #ffd700;
            font-weight: bold;
        }
        
        .rank-badge {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 5;
        }
        
        .delete-unit {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 0.9rem;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }
        
        .delete-unit:hover {
            background: #dc2626;
            transform: scale(1.1);
        }
        
        .unit-card:hover .delete-unit {
            opacity: 1;
        }

        .destroyed-label {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #ef4444;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 5;
        }
        
        .add-unit-card {
            background: linear-gradient(135deg, #2a2a3e 0%, #1a1a2e 100%);
            border: 3px dashed #666;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 160px;
        }
        
        .add-unit-card:hover {
            border-color: #ffd700;
            background: linear-gradient(135deg, #333344 0%, #2a2a3e 100%);
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(255, 215, 0, 0.2);
        }
        
        .add-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            color: #666;
            transition: all 0.3s ease;
        }
        
        .add-unit-card:hover .add-icon {
            color: #ffd700;
            transform: scale(1.1);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        @media (min-width: 640px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group-horizontal {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 90px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
    background-color: #ffd700; /* Yellow when PL is selected (toggle is checked) */
}

input:not(:checked) + .toggle-slider {
    background-color: #3b82f6; /* Blue when Points is selected (toggle is unchecked) */
        }

        input:focus + .toggle-slider {
            box-shadow: 0 0 1px #ffd700;
        }

        input:checked + .toggle-slider:before {
            -webkit-transform: translateX(56px);
            -ms-transform: translateX(56px);
            transform: translateX(56px);
        }

        .toggle-label {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 100%;
            text-align: center;
            color: #333;
            font-weight: bold;
            font-size: 0.85rem;
            pointer-events: none;
            display: flex;
            justify-content: space-between;
            padding: 0 8px;
        }
        .toggle-label span:first-child {
            color: #333; /* Color for 'PL' when Points is selected */
        }
        .toggle-label span:last-child {
            color: white; /* Color for 'Points' when PL is selected */
        }
        input:checked + .toggle-slider .toggle-label span:first-child {
            color: white; /* Color for 'PL' when PL is selected */
        }
        input:checked + .toggle-slider .toggle-label span:last-child {
            color: #333; /* Color for 'Points' when Points is selected */
        }


        .faction-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 0.5rem;
            align-items: end;
        }
        
        label {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #ffd700;
        }
        
        input, textarea, select {
            padding: 0.75rem;
            background: #1a1a2e;
            border: 2px solid #444;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
        }
        
        .faction-toggle {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .faction-toggle:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
            font-weight: bold;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #ffed4e 0%, #ffd700 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 0.5rem;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .btn-purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }
        
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #2a2a3e 0%, #1e1e2f 100%);
            border-top: 2px solid #ffd700;
            padding: 1rem;
            display: flex;
            gap: 0.5rem;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.4);
        }
        
        .bottom-bar .btn {
            flex: 1;
            font-size: 0.8rem;
            padding: 0.75rem 0.5rem;
        }
        
        .empty-state {
            text-align: center;
            color: #888;
            padding: 3rem;
            background: #1a1a2e;
            border-radius: 12px;
            border: 2px dashed #444;
        }
        
        .no-unit-selected {
            text-align: center;
            color: #888;
            padding: 3rem;
            background: #1a1a2e;
            border-radius: 12px;
            border: 2px dashed #444;
        }
        
        .no-unit-selected h3 {
            color: #ffd700;
            margin-bottom: 1rem;
        }
        
        .current-unit-info {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            padding: 1.25rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            border-left: 4px solid #ffd700;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .current-unit-info h3 {
            color: #ffd700;
            margin-bottom: 0.5rem;
        }
        
        .army-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #333;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            border-color: #ffd700;
            transform: translateY(-2px);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffd700;
            display: block;
        }
        
        .stat-label {
            color: #ccc;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .weapon-item {
            background: #1a1a2e;
            border-radius: 10px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid #333;
            transition: all 0.3s ease;
        }
        
        .weapon-item:hover {
            border-color: #ffd700;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.1);
        }
        
        .weapon-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .weapon-header h3 {
            color: #ffd700;
            margin: 0;
        }
        
        .weapon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .crusade-rank {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        .rank-fresh { background: #10b981; color: white; }
        .rank-blooded { background: #f59e0b; color: white; }
        .rank-battle-hardened { background: #ef4444; color: white; }
        .rank-heroic { background: #8b5cf6; color: white; }
        .rank-legendary { background: #ffd700; color: black; }
        
        .traits-section {
            background: #1a1a2e;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #333;
        }
        
        .trait-item {
            background: #2a2a3e;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .trait-name {
            color: #ffd700;
            font-weight: bold;
        }
        
        .trait-description {
            color: #ccc;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .rp-tracker {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            border: 2px solid #8b5cf6;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }

        .rp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .rp-title {
            color: #8b5cf6;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .rp-points {
            font-size: 2rem;
            font-weight: bold;
            color: #ffd700;
        }

        .rp-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .rp-action {
            background: #2a2a3e;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #444;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .rp-action:hover {
            border-color: #8b5cf6;
            background: #333344;
        }

        .rp-action-name {
            color: #8b5cf6;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .rp-action-cost {
            color: #ffd700;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .rp-action-desc {
            color: #ccc;
            font-size: 0.9rem;
        }

        .weapon-template-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: end;
        }

        .template-dropdown {
            flex: 1;
            min-width: 200px;
        }

        .battle-log-entry {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            border-radius: 10px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid #333;
            transition: all 0.3s ease;
            position: relative;
        }

        .battle-log-entry:hover {
            border-color: #ffd700;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.1);
        }

        .battle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .battle-header h3 {
            color: #ffd700;
            margin: 0;
            font-size: 1.1rem;
        }

        .battle-meta {
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 0.5rem;
        }

        .battle-outcome {
            font-weight: bold;
            padding: 0.25rem 0.75rem;
            border-radius: 5px;
            font-size: 0.8rem;
            display: inline-block;
            margin-left: 10px;
        }

        .outcome-win { background-color: #10b981; color: white; }
        .outcome-loss { background-color: #ef4444; color: white; }
        .outcome-draw { background-color: #f59e0b; color: white; }

        .agenda-tag {
            display: inline-block;
            background: #3b82f6;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .agenda-completion-log {
            background-color: #1a1a2e;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid #3b82f6;
        }

        .agenda-completion-log h4 {
            color: #3b82f6;
            margin-bottom: 0.5rem;
        }

        .agenda-completion-item {
            color: #ccc;
            font-size: 0.9em;
            margin-bottom: 0.25rem;
        }

        .edit-delete-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .edit-delete-buttons .btn-small {
            width: 28px;
            height: 28px;
            font-size: 0.8rem;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: linear-gradient(135deg, #2a2a3e 0%, #1a1a2e 100%);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            width: 90%;
            position: relative;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-unit-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px dashed #333;
        }

        .modal-unit-row:last-child {
            border-bottom: none;
        }

        .modal-unit-name {
            font-weight: bold;
            color: #ffd700;
            flex-grow: 1;
            margin-right: 1rem;
        }

        .modal-unit-current-xp {
            font-size: 0.9em;
            color: #aaa;
            width: 60px;
            text-align: right;
            margin-right: 0.5rem;
        }

        .modal-xp-input {
            width: 80px;
            padding: 0.5rem;
            background: #1a1a2e;
            border: 1px solid #444;
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
            text-align: center;
        }

        /* RP Ledger specific styles */
        .rp-ledger-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        
        .rp-ledger-table th, .rp-ledger-table td {
            border: 1px solid #444;
            padding: 0.75rem;
            text-align: left;
        }
        
        .rp-ledger-table th {
            background: #333;
            color: #ffd700;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.8em;
        }
        
        .rp-ledger-table tbody tr {
            background: #1a1a2e;
        }
        
        .rp-ledger-table tbody tr:nth-child(even) {
            background: #2a2a3e;
        }
        
        .rp-ledger-table td.gain {
            color: #10b981;
            font-weight: bold;
        }
        
        .rp-ledger-table td.spend {
            color: #ef4444;
            font-weight: bold;
        }
        
        .rp-ledger-table td.balance {
            color: #ffd700;
            font-weight: bold;
        }

        /* Rule description */
        .rule-description {
            background-color: #1a1a2e;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            color: #bbb;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }

        .rule-description.active {
            max-height: 150px; /* Adjust as needed */
            opacity: 1;
        }

        /* Agenda Tab Styles */
        .agenda-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1a1a2e;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border: 1px solid #333;
        }
        
        .agenda-details {
            flex-grow: 1;
        }

        .agenda-name {
            color: #3b82f6;
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .agenda-reward {
            color: #ffd700;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .agenda-description {
            color: #ccc;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .agenda-assignment-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px dashed #444;
        }
        .agenda-assignment-row:last-child {
            border-bottom: none;
        }

        .agenda-assignment-unit-name {
            flex-basis: 30%;
            font-weight: bold;
            color: #ffd700;
        }
        .agenda-assignment-select {
            flex-grow: 1;
        }

        .manual-entry-section {
            background: #2a2a3e;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            border: 1px solid #444;
        }

        .manual-entry-section h4 {
            color: #ffd700;
            margin-bottom: 0.75rem;
        }

        .manual-entry-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        @media (min-width: 640px) {
            .manual-entry-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .faction-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .weapon-grid {
                grid-template-columns: 1fr;
            }

            .weapon-template-selector {
                flex-direction: column;
                align-items: stretch;
            }

            .template-dropdown {
                min-width: unset;
            }

            .form-grid {
                grid-template-columns: 1fr; /* Stack columns on small screens */
            }

            .rp-ledger-table, .rp-ledger-table thead, .rp-ledger-table tbody, .rp-ledger-table th, .rp-ledger-table td, .rp-ledger-table tr { 
                display: block; 
            }
            
            /* Hide table headers (but not display: none;, for accessibility) */
            .rp-ledger-table thead tr { 
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            
            .rp-ledger-table tr { border: 1px solid #444; margin-bottom: 1rem; border-radius: 10px; overflow: hidden;}
            
            .rp-ledger-table td { 
                border: none;
                border-bottom: 1px solid #eee; 
                position: relative;
                padding-left: 50%; 
                text-align: right;
            }
            
            .rp-ledger-table td:before { 
                position: absolute;
                top: 0;
                left: 6px;
                width: 45%; 
                padding-right: 10px; 
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: #ccc;
            }
            
            .rp-ledger-table td:nth-of-type(1):before { content: "Date"; }
            .rp-ledger-table td:nth-of-type(2):before { content: "Type"; }
            .rp-ledger-table td:nth-of-type(3):before { content: "Description"; }
            .rp-ledger-table td:nth-of-type(4):before { content: "Amount"; }
            .rp-ledger-table td:nth-of-type(5):before { content: "Balance"; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üõ°Ô∏è Crusade Tracker</h1>
        <div class="header-actions">
            <button class="btn btn-primary btn-small" id="create-new-unit-btn">+ New Unit</button>
            <button class="btn btn-purple btn-small" id="export-data-btn">üìÅ Export</button>
            <button class="btn btn-info btn-small" id="import-data-btn">üì• Import</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" id="units-tab-btn" data-tab="units">üèõÔ∏è Units</button>
        <button class="tab" id="details-tab-btn" data-tab="details">üìä Details</button>
        <button class="tab" id="weapons-tab-btn" data-tab="weapons">‚öîÔ∏è Weapons</button>
        <button class="tab" id="progress-tab-btn" data-tab="progress">üìà Progress</button>
        <button class="tab" id="traits-tab-btn" data-tab="traits">‚ú® Traits</button>
        <button class="tab" id="agendas-tab-btn" data-tab="agendas">üìú Agendas</button>
        <button class="tab" id="requisition-tab-btn" data-tab="requisition">üéñÔ∏è Requisition</button>
        <button class="tab" id="rp-ledger-tab-btn" data-tab="rp-ledger">üìú RP Ledger</button>
        <button class="tab" id="army-tab-btn" data-tab="army">üéØ Army</button>
        <button class="tab" id="crusade-log-tab-btn" data-tab="crusade-log">üìú Log</button>
    </div>

    <div class="content">
        <div id="units-tab-content" class="tab-content active">
            <div class="card">
                <h2>Your Crusade Force</h2>
                <div id="units-grid" class="unit-grid"></div>
            </div>
        </div>

        <div id="army-tab-content" class="tab-content">
            <div id="army-overview-content">
                <div class="card">
                    <h2>üèõÔ∏è Army Overview</h2>
                    <div class="army-stats">
                        <div class="stat-card">
                            <span class="stat-number" id="total-units">0</span>
                            <div class="stat-label">Total Units</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="total-points">0</span>
                            <div class="stat-label">Total Points</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="total-pl">0</span>
                            <div class="stat-label">Total Power Level</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="current-supply-limit">0</span>
                            <div class="stat-label">Current Supply Limit (<span id="supply-limit-type"></span>)</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="remaining-supply-limit">0</span>
                            <div class="stat-label">Remaining Supply (<span id="remaining-supply-type"></span>)</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="total-xp">0</span>
                            <div class="stat-label">Total Experience</div>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="total-battles">0</span>
                            <div class="stat-label">Total Battles</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2>‚öôÔ∏è Army Management</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="army-name-input">Army Name</label>
                            <input type="text" id="army-name-input" value="My Crusade Force" placeholder="Enter army name">
                        </div>
                        <div class="form-group">
                            <label for="crusade-level-select">Crusade Level</label>
                            <select id="crusade-level-select">
                                <option value="Incursion">Incursion (50 PL = 1000 Points)</option>
                                <option value="Strike Force">Strike Force (100 PL = 2000 Points)</option>
                                <option value="Onslaught">Onslaught (150 PL = 3000 Points)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="army-rp-input">Army Requisition Points</label>
                            <input type="number" id="army-rp-input" value="5" min="0">
                        </div>
                        <div class="form-group form-group-horizontal" style="grid-column: 1 / -1; align-items: center;">
    <label for="tracking-mode-toggle" style="margin-bottom: 0;">Track by:</label>
    <span id="tracking-mode-text" style="margin-right: 10px; font-weight: bold; color: #3b82f6;">Points</span>
    <label class="toggle-switch">
        <input type="checkbox" id="tracking-mode-toggle">
        <span class="toggle-slider round">
            <span class="toggle-label"><span>PL</span><span>Points</span></span>
        </span>
    </label>
</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="details-tab-content" class="tab-content">
            <div id="unit-details-content">
                <div class="no-unit-selected">
                    <h3>No Unit Selected</h3>
                    <p>Select a unit from the Units tab to view and edit its details.</p>
                </div>
            </div>
        </div>

        <div id="weapons-tab-content" class="tab-content">
            <div id="weapons-content">
                <div class="no-unit-selected">
                    <h3>No Unit Selected</h3>
                    <p>Select a unit from the Units tab to manage its weapons.</p>
                </div>
            </div>
        </div>

        <div id="progress-tab-content" class="tab-content">
            <div id="progress-content">
                <div class="no-unit-selected">
                    <h3>No Unit Selected</h3>
                    <p>Select a unit from the Units tab to track its crusade progress.</p>
                </div>
            </div>
        </div>

        <div id="traits-tab-content" class="tab-content">
            <div id="traits-content">
                <div class="no-unit-selected">
                    <h3>No Unit Selected</h3>
                    <p>Select a unit from the Units tab to manage its traits and scars.</p>
                </div>
            </div>
        </div>

        <div id="agendas-tab-content" class="tab-content">
            <div class="card">
                <h2>Define Crusade Agendas</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="new-agenda-name">Agenda Name</label>
                        <input type="text" id="new-agenda-name" placeholder="e.g., Assassinate">
                    </div>
                    <div class="form-group">
                        <label for="new-agenda-xp">XP Reward</label>
                        <input type="number" id="new-agenda-xp" value="1" min="0">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="new-agenda-desc">Description / Completion Criteria</label>
                        <textarea id="new-agenda-desc" rows="3" placeholder="Describe how to complete this agenda..."></textarea>
                    </div>
                </div>
                <button class="btn btn-primary" id="add-new-agenda-btn" style="margin-top: 1rem;">Add New Agenda</button>
            </div>
            <div class="card">
                <h2>Available Agendas</h2>
                <div id="agenda-list">
                    <!-- Agendas will be rendered here -->
                </div>
            </div>
            <div class="card">
                <h2>Assign Agendas to Units</h2>
                <div id="agenda-assignment-list">
                    <!-- Unit assignment rows will be rendered here -->
                </div>
            </div>
        </div>

        <div id="requisition-tab-content" class="tab-content">
            <div id="requisition-content">
                <div class="no-unit-selected">
                    <h3>No Unit Selected</h3>
                    <p>Select a unit from the Units tab to manage requisition points.</p>
                </div>
            </div>
        </div>

        <div id="rp-ledger-tab-content" class="tab-content">
            <div class="card">
                <h2>üìú Requisition Point Ledger</h2>
                <div style="color: #ccc; margin-bottom: 1rem;">
                    Current Army RP: <strong id="ledger-current-rp">0</strong>
                </div>
                <div id="rp-ledger-list" style="max-height: 70vh; overflow-y: auto;">
                    <div class="empty-state">No RP transactions recorded yet.</div>
                </div>
            </div>
        </div>

        <div id="crusade-log-tab-content" class="tab-content">
            <div id="crusade-log-content">
                <div class="card">
                    <h2>üìù Record New Battle</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="log-date">Date</label>
                            <input type="date" id="log-date" value="">
                        </div>
                        <div class="form-group">
                            <label for="log-opponent">Opponent Faction</label>
                            <input type="text" id="log-opponent" placeholder="e.g., Necrons, Chaos Space Marines">
                        </div>
                        <div class="form-group">
                            <label for="log-mission">Mission</label>
                            <input type="text" id="log-mission" placeholder="e.g., Sweep and Clear, Crucible of War">
                        </div>
                        <div class="form-group">
                            <label for="log-outcome">Outcome</label>
                            <select id="log-outcome">
                                <option value="">Select Outcome</option>
                                <option value="Win">Win</option>
                                <option value="Loss">Loss</option>
                                <option value="Draw">Draw</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="log-xp-gained">Base XP Gained (For Distribution)</label>
                            <input type="number" id="log-xp-gained" value="0" min="0">
                        </div>
                        <div class="form-group">
                            <label for="log-rp-gained">RP Gained (Total Army)</label>
                            <input type="number" id="log-rp-gained" value="0" min="0">
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="log-notes">Battle Notes</label>
                            <textarea rows="3" id="log-notes" placeholder="Any memorable moments or details from the battle..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>üéØ Agenda Completion for this Battle</h2>
                    <div id="battle-agenda-tracker">
                        <!-- Agenda tracking per unit will be rendered here -->
                        <div class="empty-state">No active units with agendas assigned.</div>
                    </div>
                </div>

                <div class="card" style="text-align: center;">
                     <button class="btn btn-primary" id="record-battle-btn" style="padding: 1rem 2rem; font-size: 1.1rem;">Record Battle & Apply XP</button>
                </div>

                <div class="card">
                    <h2>üìú Crusade Battle Log</h2>
                    <div id="battle-log-list">
                        <div class="empty-state">No battles recorded yet.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        <button class="btn btn-success" id="save-data-btn">üíæ Save</button>
        <button class="btn btn-info" id="load-data-btn">üìÇ Load</button>
        <button class="btn btn-warning" id="print-unit-btn">üñ®Ô∏è Print</button>
        <button class="btn btn-primary" id="add-new-unit-bottom-btn">‚ûï New Unit</button>
    </div>

    <!-- Modal for XP Distribution -->
    <div id="xp-distribution-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content card" style="max-width: 600px; margin: 50px auto; padding: 2rem;">
            <h2 style="color: #ffd700; margin-bottom: 1rem;">Distribute Experience Points</h2>
            <p style="color: #ccc; margin-bottom: 1rem;">Total XP from battle: <strong id="modal-total-xp">0</strong></p>
            <p style="color: #ccc; margin-bottom: 1rem;">XP Remaining to Distribute: <strong id="modal-xp-remaining">0</strong></p>
            
            <div id="modal-unit-xp-inputs" style="max-height: 400px; overflow-y: auto; margin-bottom: 1.5rem; padding-right: 10px;">
                <!-- Unit XP input fields will be rendered here -->
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-primary" id="distribute-xp-confirm-btn">Distribute XP</button>
                <button class="btn btn-danger" id="distribute-xp-cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for Revive Unit -->
    <div id="revive-unit-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content card" style="max-width: 500px; margin: 50px auto; padding: 2rem;">
            <h2 style="color: #ffd700; margin-bottom: 1rem;">Revive Unit (Combat Revival)</h2>
            <p style="color: #ccc; margin-bottom: 1rem;">Cost: 1 Requisition Point</p>
            <div id="revive-unit-list" style="max-height: 400px; overflow-y: auto; margin-bottom: 1.5rem; padding-right: 10px;">
                <!-- Destroyed units will be listed here -->
                <div class="empty-state" style="padding: 1rem; border: none; background: transparent;">No destroyed units to revive.</div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-primary" id="revive-unit-confirm-btn" disabled>Revive Selected Unit</button>
                <button class="btn btn-danger" id="revive-unit-cancel-btn">Cancel</button>
            </div>
        </div>
    </div>


    <!-- Modal for Out of Action Roll -->
    <div id="ooa-roll-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content card" style="max-width: 400px; margin: 50px auto; padding: 2rem;">
            <h2 style="color: #ffd700; margin-bottom: 1rem;">Out of Action Roll (<span id="ooa-unit-name"></span>)</h2>
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label for="ooa-dice-roll">Enter D6 Roll (1-6):</label>
                <input type="number" id="ooa-dice-roll" min="1" max="6" placeholder="e.g., 4">
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-primary" id="ooa-apply-btn">Apply Result</button>
                <button class="btn btn-danger" id="ooa-cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Global Data
        var crusadeData = {
            units: [],
            currentUnitId: null,
            nextUnitId: 1,
            armyName: 'My Crusade Force',
            supplyLimitPoints: 50, // Renamed from initialPoints, now represents PL limit
            crusadeLevel: 'Incursion', // 'Incursion' (50 PL), 'Strike Force' (100 PL), 'Onslaught' (150 PL)
            requisitionPoints: 5,
            crusadeLog: [], 
            warlord: null, // To track the army warlord unit ID
            rpLedger: [],
            crusadeAgendas: [], // New: Agendas
            trackByPoints: true, // NEW: true for points, false for power level
            pointsPerPowerLevel: 20 // Conversion rate: 1 PL = 20 points
        };

        // Define Crusade Levels and their associated PL limits
        const CRUSADE_LEVELS = {
            'Incursion': 50,
            'Strike Force': 100,
            'Onslaught': 150
        };

        // Helper to generate unique ID for ledger entries
        function generateLedgerId() {
            const maxId = crusadeData.rpLedger.reduce((max, entry) => Math.max(max, entry.id), 0);
            return maxId + 1;
        }

        var factionData = {
            'Space Marines': {
                'Ultramarines': { color: '#0066cc', traits: ['Courage and Honour', 'Tactical Doctrine'] },
                'Blood Angels': { color: '#cc0000', traits: ['Red Thirst', 'Black Rage'] },
                'Dark Angels': { color: '#006600', traits: ['Grim Resolve', 'Inner Circle'] },
                'Space Wolves': { color: '#666666', traits: ['Savage Fury', 'Hunters Unleashed'] },
                'Imperial Fists': { color: '#ffcc00', traits: ['Siege Masters', 'Bolter Drill'] },
                'Iron Hands': { color: '#333333', traits: ['The Flesh is Weak', 'Machine Empathy'] },
                'Salamanders': { color: '#339933', traits: ['Master Artisans', 'Flamecraft'] },
                'Raven Guard': { color: '#000000', traits: ['Shadow Masters', 'Swift and Deadly'] },
                'White Scars': { color: '#ffffff', traits: ['Lightning Assault', 'Born in the Saddle'] },
                'Black Templars': { color: '#000000', traits: ['No Pity! No Remorse! No Fear!', 'Righteous Zeal'] },
                'Crimson Fists': { color: '#cc0000', traits: ['No Matter the Odds', 'Bolter Fury'] },
                'Iron Fists': { color: '#404040', traits: ['Siege Warfare', 'Stubborn Defiance'] },
                'Lamenters': { color: '#ffff00', traits: ['Sons of Sanguinius', 'Cursed Founding'] },
                'Flesh Tearers': { color: '#800000', traits: ['Fury of the Lost', 'Death Company'] },
                'Red Scorpions': { color: '#ff6600', traits: ['Pure Gene-seed', 'Apothecary Expertise'] }
            },
            'Chaos Space Marines': {
                'Black Legion': { color: '#000000', traits: ['Black Crusade', 'Chaos Ascendant'] },
                'Word Bearers': { color: '#800000', traits: ['Dark Zealotry', 'Daemon Summoning'] },
                'Iron Warriors': { color: '#404040', traits: ['Siege Lords', 'Cold Hatred'] },
                'Night Lords': { color: '#000080', traits: ['Terror Tactics', 'From the Shadows'] },
                'World Eaters': { color: '#ff0000', traits: ['Berzerker Assault', 'Blood for the Blood God'] },
                'Emperor\'s Children': { color: '#ff00ff', traits: ['Flawless Perfection', 'Excess of Violence'] },
                'Death Guard': { color: '#006600', traits: ['Plague Host', 'Inexorable Advance'] },
                'Thousand Sons': { color: '#0066cc', traits: ['Cabalistic Rituals', 'Warpflame Gargoyles'] },
                'Alpha Legion': { color: '#336699', traits: ['Hidden in Plain Sight', 'Hydra Doctrine'] },
                'Crimson Slaughter': { color: '#cc0000', traits: ['Marked by Slaughter', 'Chaos Boon'] },
                'Red Corsairs': { color: '#cc0000', traits: ['Renegade Raiders', 'Maelstrom Born'] }
            },
            'Astra Militarum': {
                'Cadian Shock Troops': { color: '#006600', traits: ['Cadian Doctrine', 'Born Soldiers'] },
                'Catachan Jungle Fighters': { color: '#339933', traits: ['Brutal Strength', 'Jungle Fighters'] },
                'Armageddon Steel Legion': { color: '#666666', traits: ['Industrial Efficiency', 'Mobile Infantry'] },
                'Mordian Iron Guard': { color: '#000080', traits: ['Parade Drill', 'Disciplined Ranks'] },
                'Tallarn Desert Raiders': { color: '#cc9900', traits: ['Swift as the Wind', 'Ambush'] },
                'Vostroyan Firstborn': { color: '#cc0000', traits: ['Firstborn Pride', 'Heirloom Weapons'] },
                'Valhallan Ice Warriors': { color: '#cccccc', traits: ['For the Homeland', 'Grim Demeanour'] },
                'Krieg Death Korps': { color: '#404040', traits: ['Death Before Dishonour', 'Cult of Sacrifice'] },
                'Elysian Drop Troops': { color: '#0066cc', traits: ['Aerial Drop', 'Combat Drop'] },
                'Harakoni Warhawks': { color: '#ff6600', traits: ['Grav-chute Assault', 'Void Warfare'] }
            },
            'Orks': {
                'Goffs': { color: '#000000', traits: ['No Mukkin\' About', 'Proper Killy'] },
                'Evil Sunz': { color: '#ff0000', traits: ['Red Ones Go Fasta', 'Speedwaaagh!'] },
                'Bad Moons': { color: '#ffff00', traits: ['Loads of Teef', 'Shooty Gits'] },
                'Deathskulls': { color: '#0066cc', traits: ['Lucky Blue Gits', 'Salvage'] },
                'Blood Axes': { color: '#006600', traits: ['Sneaky Gits', 'Kommando Tactics'] },
                'Snakebites': { color: '#663300', traits: ['Old Ways', 'Tough as Squig Hide'] },
                'Freebooterz': { color: '#800080', traits: ['Competitive Streak', 'Showing Off'] }
            },
            'Aeldari': {
                'Craftworld Ulthw√©': { color: '#000000', traits: ['Foresight of the Damned', 'Psyker Mastery'] },
                'Craftworld Biel-Tan': { color: '#006600', traits: ['Swordwind', 'Martial Pride'] },
                'Craftworld Saim-Hann': { color: '#ff0000', traits: ['Wild Riders', 'Speed of the Wind'] },
                'Craftworld Alaitoc': { color: '#0066cc', traits: ['Masters of Concealment', 'Rangers'] },
                'Craftworld Iyanden': { color: '#ffff00', traits: ['Stoic Endurance', 'Wraith Sight'] },
                'Craftworld Mymeara': { color: '#800080', traits: ['Phoenix Lords', 'Ancient Glory'] },
                'Ynnari': { color: '#666666', traits: ['Power from Death', 'Reborn Warhost'] },
                'Harlequins': { color: '#ff00ff', traits: ['Rising Crescendo', 'Player of the Light'] }
            },
            'Drukhari': {
                'Kabal of the Black Heart': { color: '#000000', traits: ['Thirst for Power', 'Flawless Raid'] },
                'Kabal of the Flayed Skull': { color: '#cccccc', traits: ['Hyperswift Attack', 'Surgical Precision'] },
                'Kabal of the Obsidian Rose': { color: '#800080', traits: ['Flawless Technique', 'Deadly Precision'] },
                'Kabal of the Poisoned Tongue': { color: '#006600', traits: ['Masters of the Poisoned Arts', 'Alchemical Mastery'] },
                'Wych Cult of Strife': { color: '#ff0000', traits: ['The Spectacle of Murder', 'No Method of Death Beyond Us'] },
                'Wych Cult of the Cursed Blade': { color: '#000080', traits: ['Only War', 'Red Grief'] },
                'Coven of the Prophets of Flesh': { color: '#cc0066', traits: ['Connoisseurs of Pain', 'Master Torturers'] }
            },
            'T\'au Empire': {
                'T\'au Sept': { color: '#cc9900', traits: ['Coordinated Firepower', 'For the Greater Good'] },
                'Dal\'yth Sept': { color: '#0066cc', traits: ['Adaptive Camouflage', 'Territorial Hunters'] },
                'Sa\'cea Sept': { color: '#ffffff', traits: ['Calm Discipline', 'Firepower Efficiency'] },
                'Vior\'la Sept': { color: '#ff0000', traits: ['Strike Fast', 'Hot-blooded'] },
                'Bork\'an Sept': { color: '#006600', traits: ['Advanced Targeting Systems', 'Superior Craftsmanship'] },
                'Farsight Enclaves': { color: '#ff6600', traits: ['Aggressive Tactics', 'Independent Spirit'] },
                'Ke\'lshan Sept': { color: '#800080', traits: ['Hardened by War', 'Ork Hunters'] }
            },
            'Necrons': {
                'Sautekh Dynasty': { color: '#ffff00', traits: ['Relentless March', 'Hyperlogical Strategy'] },
                'Mephrit Dynasty': { color: '#ff6600', traits: ['Solar Fury', 'Aggressive Expansion'] },
                'Novokh Dynasty': { color: '#ff0000', traits: ['Awakened by Murder', 'Honour in Death'] },
                'Nephrekh Dynasty': { color: '#0066cc', traits: ['Translocation Protocols', 'Phase Walker'] },
                'Nihilakh Dynasty': { color: '#006600', traits: ['Obsessional Claim', 'Defensive Protocols'] },
                'Szerakhan Dynasty': { color: '#800080', traits: ['The Eternal Conquerors', 'Immovable Phalanxes'] }
            },
            'Tyranids': {
                'Hive Fleet Leviathan': { color: '#800080', traits: ['Swarming Masses', 'Synaptic Imperatives'] },
                'Hive Fleet Behemoth': { color: '#0066cc', traits: ['Unstoppable Hunger', 'Endless Swarm'] },
                'Hive Fleet Kraken': { color: '#ff0000', traits: ['Lightning Fast', 'Hyper-evolution'] },
                'Hive Fleet Jormungandr': { color: '#cc9900', traits: ['Tunnel Networks', 'Subterranean Assault'] },
                'Hive Fleet Hydra': { color: '#006600', traits: ['Adaptive Biology', 'Split and Consume'] },
                'Hive Fleet Gorgon': { color: '#339933', traits: ['Toxic Miasma', 'Bio-acidic Assault'] }
            },
            'Adeptus Mechanicus': {
                'Forge World Mars': { color: '#ff0000', traits: ['Red Planet\'s Blessing', 'Quest for Knowledge'] },
                'Forge World Lucius': { color: '#ffff00', traits: ['Solar Blessing', 'Luminescent Blessing'] },
                'Forge World Agripinaa': { color: '#666666', traits: ['Staunch Defenders', 'Fortress Logic'] },
                'Forge World Stygies VIII': { color: '#000080', traits: ['Xenos Technology', 'Stygies Infiltrators'] },
                'Forge World Ryza': { color: '#ff6600', traits: ['Plasma Specialists', 'Red in Cog and Claw'] },
                'Forge World Graia': { color: '#0066cc', traits: ['Refusal to Yield', 'Graia\'s Favour'] },
                'Forge World Metalica': { color: '#cccccc', traits: ['Relentless March', 'Metalican Lung'] }
            },
            'Adepta Sororitas': {
                'Order of Our Martyred Lady': { color: '#000000', traits: ['Suffer Not the Unclean', 'Hand of the Emperor'] },
                'Order of the Valorous Heart': { color: '#ff0000', traits: ['Impervious to Pain', 'Stoic Endurance'] },
                'Order of the Bloody Rose': { color: '#cc0000', traits: ['Quick to Anger', 'Zealous Fervour'] },
                'Order of the Ebon Chalice': { color: '#800080', traits: ['Spiritual Leaders', 'Holy Rage'] },
                'Order of the Argent Shroud': { color: '#cccccc', traits: ['Defenders of the Faith', 'Aegis of Faith'] },
                'Order of the Sacred Rose': { color: '#ff69b4', traits: ['Purity of Faith', 'Healing Balm'] }
            },
            'Imperial Knights': {
                'House Terryn': { color: '#0066cc', traits: ['Gallant Warriors', 'Glory in Honour'] },
                'House Cadmus': { color: '#006600', traits: ['Hunters of the Foe', 'Noble Combatants'] },
                'House Griffith': { color: '#ffff00', traits: ['Chivalric Oaths', 'Knight Seneschal'] },
                'House Hawkshroud': { color: '#ff6600', traits: ['Oathkeepers', 'Duty Unto Death'] },
                'House Mortan': { color: '#666666', traits: ['Close-quarters Killers', 'Slayers of Beasts'] },
                'House Raven': { color: '#000000', traits: ['Relentless Advance', 'Machine Focus'] },
                'House Taranis': { color: '#ff0000', traits: ['Red Planet\'s Favour', 'Blessed by the Omnissiah'] }
            },
            'Chaos Knights': {
                'House Herpetrax': { color: '#800080', traits: ['Daemonic Surge', 'Warp Haunted'] },
                'House Lucaris': { color: '#cc0000', traits: ['Perfidious Machine Spirits', 'Chaos Ascendant'] },
                'House Korvax': { color: '#000000', traits: ['Melee Specialists', 'Favour of the Dark Gods'] },
                'Iconoclast Households': { color: '#ff0000', traits: ['Anarchic Fury', 'Spiteful Demise'] },
                'Infernal Households': { color: '#ff6600', traits: ['Daemonic Power', 'Infernal Presence'] }
            },
            'Chaos Daemons': {
                'Khorne Daemons': { color: '#ff0000', traits: ['Blood for the Blood God', 'Frenzied Devotion'] },
                'Tzeentch Daemons': { color: '#0066cc', traits: ['Change Incarnate', 'Warpfire'] },
                'Nurgle Daemons': { color: '#006600', traits: ['Disgustingly Resilient', 'Plague Ridden'] },
                'Slaanesh Daemons': { color: '#ff00ff', traits: ['Excess of Violence', 'Quicksilver Swiftness'] },
                'Undivided Daemons': { color: '#333333', traits: ['Chaos Ascendant', 'Warp Entity'] }
            },
            'Genestealer Cults': {
                'Cult of the Four-Armed Emperor': { color: '#800080', traits: ['Brood Brothers', 'Perfect Ambush'] },
                'Twisted Helix': { color: '#006600', traits: ['Experimental Subjects', 'Monstrous Bio-horrors'] },
                'Rusted Claw': { color: '#cc9900', traits: ['Industrial Affinity', 'Scavenged Weaponry'] },
                'Pauper Princes': { color: '#666666', traits: ['Wealth of Worlds', 'Oppressor\'s Bane'] },
                'Bladed Cog': { color: '#ff6600', traits: ['Tech-adepts', 'Blessed Machines'] }
            },
            'Leagues of Votann': {
                'Greater Thurian League': { color: '#ff6600', traits: ['Ancestral Judgement', 'A Grudge to Settle'] },
                'Ymyr Conglomerate': { color: '#0066cc', traits: ['Ruthless Efficiency', 'Void Prospectors'] },
                'Trans-Hyperian Alliance': { color: '#cc9900', traits: ['Mercenary Nature', 'Adaptive Strategy'] },
                'Seran-Tok Mercantile': { color: '#006600', traits: ['Trade Mastery', 'Profit Above All'] },
                'Kronus Hegemony': { color: '#800080', traits: ['Stronghold Assault', 'Fortress Worlds'] }
            },
            'World Eaters': {
                'Betrayer\'s Nails': { color: '#ff0000', traits: ['Butcher\'s Nails', 'Blood-mad Berzerkers'] },
                'Butcherhorde': { color: '#cc0000', traits: ['Red Tide', 'Endless Slaughter'] },
                'Red Tide': { color: '#800000', traits: ['Gore-slick Ground', 'Tides of Blood'] },
                'Skulltakers': { color: '#ff6666', traits: ['Skull Harvest', 'Champions of Khorne'] }
            },
            'Imperial Agents': {
                'Inquisition': { color: '#000000', traits: ['Authority of the Throne', 'Fearless Investigation'] },
                'Officio Assassinorum': { color: '#666666', traits: ['Precision Killers', 'Death Cult'] },
                'Adeptus Arbites': { color: '#0066cc', traits: ['Judge, Jury, Executioner', 'Law and Order'] },
                'Rogue Traders': { color: '#ffff00', traits: ['Warrant of Trade', 'Into the Unknown'] },
                'Deathwatch': { color: '#000000', traits: ['Xenos Hunters', 'Kill Team Specialists'] },
                'Sisters of Silence': { color: '#cccccc', traits: ['Psychic Abomination', 'Silent Sisterhood'] }
            }
        };

        var weaponTemplates = {
            ranged: {
                'Basic Weapons': {
                    'Bolter': { name: 'Bolter', range: '24"', attacks: '2', bs: '3+', strength: '4', ap: '0', damage: '1', abilities: 'Rapid Fire 1' },
                    'Bolt Rifle': { name: 'Bolt Rifle', range: '30"', attacks: '2', bs: '3+', strength: '4', ap: '-1', damage: '1', abilities: 'Rapid Fire 1' },
                    'Lasgun': { name: 'Lasgun', range: '24"', attacks: '1', bs: '4+', strength: '3', ap: '0', damage: '1', abilities: 'Rapid Fire 1' },
                    'Autogun': { name: 'Autogun', range: '24"', attacks: '1', bs: '4+', strength: '3', ap: '0', damage: '1', abilities: 'Rapid Fire 1' },
                    'Shotgun': { name: 'Shotgun', range: '12"', attacks: '2', bs: '3+', strength: '3', ap: '0', damage: '1', abilities: 'Assault 2' },
                    'Carbine': { name: 'Carbine', range: '18"', attacks: '2', bs: '3+', strength: '4', ap: '0', damage: '1', abilities: 'Assault 2' }
                },
                'Special Weapons': {
                    'Plasma Gun': { name: 'Plasma Gun', range: '24"', attacks: '1', bs: '3+', strength: '7', ap: '-3', damage: '2', abilities: 'Gets Hot' },
                    'Meltagun': { name: 'Meltagun', range: '12"', attacks: '1', bs: '3+', strength: '8', ap: '-4', damage: 'D6', abilities: 'Melta' },
                    'Flamer': { name: 'Flamer', range: '12"', attacks: 'D6', bs: 'Auto', strength: '4', ap: '0', damage: '1', abilities: 'Torrent' },
                    'Grav-gun': { name: 'Grav-gun', range: '18"', attacks: '2', bs: '3+', strength: '5', ap: '-1', damage: '1', abilities: 'Gravitational' },
                    'Storm Bolter': { name: 'Storm Bolter', range: '24"', attacks: '2', bs: '3+', strength: '4', ap: '0', damage: '1', abilities: 'Rapid Fire 2' },
                    'Combi-plasma': { name: 'Combi-plasma', range: '24"', attacks: '1', bs: '3+', strength: '7', ap: '-3', damage: '2', abilities: 'Combi, Gets Hot' },
                    'Combi-melta': { name: 'Combi-melta', range: '12"', attacks: '1', bs: '3+', strength: '8', ap: '-4', damage: 'D6', abilities: 'Combi, Melta' }
                },
                'Heavy Weapons': {
                    'Heavy Bolter': { name: 'Heavy Bolter', range: '36"', attacks: '3', bs: '4+', strength: '5', ap: '-1', damage: '2', abilities: 'Heavy 3' },
                    'Lascannon': { name: 'Lascannon', range: '48"', attacks: '1', bs: '4+', strength: '9', ap: '-3', damage: 'D6', abilities: 'Heavy 1' },
                    'Missile Launcher': { name: 'Missile Launcher', range: '48"', attacks: '1', bs: '4+', strength: '9', ap: '-2', damage: 'D6', abilities: 'Heavy 1' },
                    'Autocannon': { name: 'Autocannon', range: '48"', attacks: '2', bs: '4+', strength: '7', ap: '-1', damage: '2', abilities: 'Heavy 2' },
                    'Multi-melta': { name: 'Multi-melta', range: '24"', attacks: '2', bs: '4+', strength: '8', ap: '-4', damage: 'D6', abilities: 'Heavy 2, Melta' },
                    'Plasma Cannon': { name: 'Plasma Cannon', range: '36"', attacks: 'D3', bs: '4+', strength: '7', ap: '-3', damage: '2', abilities: 'Heavy D3, Gets Hot' },
                    'Assault Cannon': { name: 'Assault Cannon', range: '24"', attacks: '6', bs: '3+', strength: '6', ap: '-1', damage: '1', abilities: 'Heavy 6' }
                },
                'Pistols': {
                    'Bolt Pistol': { name: 'Bolt Pistol', range: '12"', attacks: '1', bs: '3+', strength: '4', ap: '0', damage: '1', abilities: 'Pistol 1' },
                    'Laspistol': { name: 'Laspistol', range: '12"', attacks: '1', bs: '4+', strength: '3', ap: '0', damage: '1', abilities: 'Pistol 1' },
                    'Plasma Pistol': { name: 'Plasma Pistol', range: '12"', attacks: '1', bs: '3+', strength: '7', ap: '-3', damage: '2', abilities: 'Pistol 1, Gets Hot' },
                    'Hand Flamer': { name: 'Hand Flamer', range: '12"', attacks: 'D6', bs: 'Auto', strength: '3', ap: '0', damage: '1', abilities: 'Pistol D6, Torrent' },
                    'Inferno Pistol': { name: 'Inferno Pistol', range: '6"', attacks: '1', bs: '3+', strength: '8', ap: '-4', damage: 'D6', abilities: 'Pistol 1, Melta' }
                }
            },
            melee: {
                'Basic Melee': {
                    'Chainsword': { name: 'Chainsword', ws: '3+', attacks: '+1', strength: 'User', ap: '0', damage: '1', abilities: 'Extra Attack' },
                    'Close Combat Weapon': { name: 'Close Combat Weapon', ws: '3+', attacks: '1', strength: 'User', ap: '0', damage: '1', abilities: 'Basic' },
                    'Combat Knife': { name: 'Combat Knife', ws: '3+', attacks: '1', strength: 'User', ap: '0', damage: '1', abilities: 'Basic' },
                    'Bayonet': { name: 'Bayonet', ws: '4+', attacks: '1', strength: 'User', ap: '0', damage: '1', abilities: 'Basic' }
                },
                'Power Weapons': {
                    'Power Fist': { name: 'Power Fist', ws: '3+', attacks: '-1', strength: 'x2', ap: '-2', damage: '2', abilities: 'Unwieldy' },
                    'Power Sword': { name: 'Power Sword', ws: '3+', attacks: '1', strength: '+1', ap: '-3', damage: '1', abilities: 'Powered' },
                    'Power Axe': { name: 'Power Axe', ws: '4+', attacks: '1', strength: '+1', ap: '-2', damage: '1', abilities: 'Powered' },
                    'Lightning Claw': { name: 'Lightning Claw', ws: '3+', attacks: '1', strength: '+1', ap: '-2', damage: '1', abilities: 'Re-roll wounds' },
                    'Power Maul': { name: 'Power Maul', ws: '3+', attacks: '+2', strength: 'User', ap: '-1', damage: '1', abilities: 'Powered' }
                },
                'Specialist Weapons': {
                    'Thunder Hammer': { name: 'Thunder Hammer', ws: '4+', attacks: '-1', strength: 'x2', ap: '-2', damage: '3', abilities: 'Unwieldy, Concussive' },
                    'Force Weapon': { name: 'Force Weapon', ws: '3+', attacks: '1', strength: '+2', ap: '-1', damage: 'D3', abilities: 'Force' },
                    'Eviscerator': { name: 'Eviscerator', ws: '4+', attacks: '-1', strength: 'x2', ap: '-2', damage: '2', abilities: 'Unwieldy' },
                    'Chain Fist': { name: 'Chain Fist', ws: '4+', attacks: '-1', strength: 'x2', ap: '-3', damage: '2', abilities: 'Unwieldy' },
                    'Relic Blade': { name: 'Relic Blade', ws: '3+', attacks: '+2', strength: 'User', ap: '-3', damage: '2', abilities: 'Master-crafted' }
                }
            }
        };

        var crusadeTraits = {
            'Battle Traits': {
                'Blooded': { cost: 1, description: 'This unit has survived its first battle. +1 to Nerve tests.' },
                'Battle-Hardened': { cost: 2, description: 'This unit has proven itself in multiple engagements. +1 to hit rolls in Fight phase.' },
                'Honoured': { cost: 3, description: 'This unit has brought glory to the Chapter. Can re-roll one hit roll per turn.' },
                'Legendary': { cost: 4, description: 'This unit is spoken of in hushed tones. +1 Attack characteristic.' },
                'Relic Bearer': { cost: 2, description: 'This unit carries an ancient relic into battle. +1 to save rolls.' },
                'Marked for Greatness': { cost: 3, description: 'This unit is destined for glory. Gains an additional Warlord Trait.' }
            },
            'Weapon Enhancements': {
                'Master-crafted Weapon': { cost: 1, description: 'One weapon becomes master-crafted. Re-roll damage rolls of 1.' },
                'Venerable Weapon': { cost: 2, description: 'An ancient weapon of great power. +1 to wound rolls.' },
                'Blessed Weapon': { cost: 2, description: 'Weapon blessed by the Emperor. Deals mortal wounds on 6s to wound.' },
                'Relic Weapon': { cost: 3, description: 'A legendary weapon of immense power. +1 Strength, +1 AP.' },
                'Artificer Weapon': { cost: 2, description: 'Perfectly crafted weapon. +1 to hit rolls.' }
            },
            'Psychic Traits': {
                'Psyker': { cost: 2, description: 'This unit manifests psychic powers. Knows one additional psychic power.' },
                'Psychic Mastery': { cost: 3, description: 'Master of the warp. +1 to cast rolls, knows 2 additional powers.' },
                'Warp Sight': { cost: 1, description: 'Can see beyond the veil. Ignores cover when shooting.' },
                'Mind Shield': { cost: 2, description: 'Protected from psychic attack. 5+ invulnerable save against psychic attacks.' },
                'Psychic Familiar': { cost: 1, description: 'Accompanied by a psychic creature. Re-roll failed psychic tests.' }
            }
        };

        var battleScars = {
            'Physical Scars': {
                'Grievous Injury': { description: 'Permanent injury reduces effectiveness. -1 to a random characteristic.' },
                'Shell Shock': { description: 'Traumatized by bombardment. -1 to hit rolls when enemy is in cover.' },
                'Demolished': { description: 'Partially destroyed. -1 Wound.' },
                'Maimed': { description: 'Permanently crippled. -1 to Move characteristic.' },
                'Blinded': { description: 'Sight permanently damaged. -1 to hit rolls with ranged weapons.' },
                'Hobbled': { description: 'Movement impaired. Cannot advance and charge in same turn.' }
            },
            'Mental Scars': {
                'Haunted': { description: 'Plagued by memories. -1 to Leadership.' },
                'Jumpy': { description: 'Startled easily. Must test to charge units in cover.' },
                'Dishonoured': { description: 'Brought shame upon themselves. Cannot be selected for upgrades.' },
                'Bitter': { description: 'Consumed by hatred. Must charge nearest enemy if possible.' },
                'Craven': { description: 'Lost their nerve. -2 to charge rolls.' }
            },
            'Revival Scars': { // New category for revival
                'Resurrected': { description: 'This unit has been brought back from the brink of destruction. Consider a narrative penalty or a minor stat reduction (e.g., -1 to one characteristic, cannot auto-pass morale).' }
            }
        };

        var requisitionActions = {
            'Increase Supply Limit': { cost: 1, description: 'Increase your supply limit by 200 points.' },
            'Renowned Heroes': { cost: '1-3', description: 'Promote a unit to Heroic rank, or add a Heroic trait. Cost varies by unit.' },
            'Legendary Veterans': { cost: 3, description: 'Promote a unit to Legendary rank, or add a Legendary trait.' },
            'Rearm and Resupply': { cost: 1, description: 'Remove a Battle Scar from a unit.' },
            'Repair and Recuperate': { cost: '1-3', description: 'Remove a Battle Scar or restore lost wounds/models. Cost varies.' },
            'Fresh Recruits': { cost: '1-4', description: 'Add a new unit to your Order of Battle. Cost varies by unit power level.' },
            'Combat Revival': { cost: 1, description: 'Return a unit to your Order of Battle that was destroyed.' },
            'Manual Requisition': { cost: 'Varies', description: 'Manually enter a custom requisition action and its cost.' }
        };

        var warlordTraits = {
            'General': {
                'Master Tactician': { cost: 1, description: 'Re-roll one hit roll or wound roll per turn.' },
                'Inspiring Leader': { cost: 1, description: 'Units within 6" re-roll failed morale tests.' },
                'Tenacious Survivor': { cost: 1, description: 'Ignore wounds on a 5+.' },
                'Honoured Veteran': { cost: 1, description: '+1 Attack.' },
                'Strategist': { cost: 1, description: 'Gain +1 CP per turn on a 5+.' }
            },
            'Space Marine Warlord Traits': {
                'Iron Resolve': { cost: 1, description: 'When a save is failed, can attempt to ignore the wound on a 6+.' },
                'Student of the Codex': { cost: 1, description: 'When using a Combat Doctrine ability, a unit may affect two doctrines instead of one.' }
            },
            'Chaos Space Marine Warlord Traits': {
                'Hatred Incarnate': { cost: 1, description: 'Re-roll hit rolls for this Warlord in the Fight phase.' },
                'Warp-touched': { cost: 1, description: 'This Warlord has a 4+ invulnerable save.' }
            }
        };

        var crusadeRelics = {
            'General Relics': {
                'Pendent of the Emperor\'s Judgement': { cost: 1, description: 'Once per battle, a unit within 6" can re-roll all failed hit rolls.' },
                'Blade of the Relic Bearer': { cost: 1, description: 'Melee weapon gains +1 Strength and +1 Damage.' },
                'Armour of the Crusade': { cost: 1, description: '+1 to save throws.' },
                'Helm of the Paragon': { cost: 1, description: '+1 Leadership.' }
            },
            'Space Marine Relics': {
                'The Shield of Eternity': { cost: 1, description: 'Bearer has a 4+ invulnerable save.' },
                'Burning Blade': { cost: 1, description: 'Melee weapon gains S+2, AP-4, D3 damage.' }
            },
            'Astra Militarum Relics': {
                'Relic of the Lost Cadia': { cost: 1, description: 'Units within 6" automatically pass morale tests.' },
                'The Death Mask of Ollanius': { cost: 1, description: 'Bearer has a 4+ invulnerable save.' }
            }
        };

        var outOfActionResults = {
            1: { xp: 1, scar: { category: 'Physical Scars', name: 'Grievous Injury' }, description: 'Grievous Injury: Unit gains 1 XP and a Grievous Injury scar.' },
            2: { xp: 1, scar: { category: 'Mental Scars', name: 'Shell Shock' }, description: 'Shell Shock: Unit gains 1 XP and a Shell Shock scar.' },
            3: { xp: 1, scar: { category: 'Mental Scars', name: 'Jumpy' }, description: 'Jumpy: Unit gains 1 XP and a Jumpy scar.' },
            4: { xp: 2, scar: null, description: 'Nothing Serious: Unit gains 2 XP. No lasting effects.' },
            5: { xp: 3, scar: null, description: 'Inspired Recovery: Unit gains 3 XP. They learned from their mistakes.' },
            6: { xp: 5, scar: null, description: 'Heroic Recovery: Unit gains 5 XP. A truly miraculous recovery!' }
        };

        // Helper to get rank name and CSS class based on XP
        function getCrusadeRank(xp) {
            if (xp >= 101) return { name: 'Legendary', class: 'rank-legendary', bonus: '+1 Attack characteristic for all weapons, or a bespoke narrative honour.' };
            if (xp >= 51) return { name: 'Heroic', class: 'rank-heroic', bonus: 'Gains an additional Battle Trait OR Crusade Relic (if character).' };
            if (xp >= 31) return { name: 'Battle-Hardened', class: 'rank-battle-hardened', bonus: '+1 Wound characteristic (if infantry/bike/beast) or +1 Toughness (if vehicle/monster).' };
            if (xp >= 6) return { name: 'Blooded', class: 'rank-blooded', bonus: 'Can re-roll one hit roll or wound roll per battle, or gain +1 Leadership.' };
            return { name: 'Fresh', class: 'rank-fresh', bonus: 'None.' };
        }

        // Generate unique unit ID
        function generateUnitId() {
            return crusadeData.nextUnitId++;
        }

        // Get the currently selected unit
        function getCurrentUnit() {
            try {
                if (!crusadeData.currentUnitId) return null;
                return crusadeData.units.find(function(unit) {
                    return unit.id === crusadeData.currentUnitId;
                });
            } catch (error) {
                console.error("Error in getCurrentUnit:", error);
                return null;
            }
        }

        // Helper function for conversion
        function convertPointsToPL(points) {
            return Math.ceil(points / crusadeData.pointsPerPowerLevel);
        }

        function convertPLToPoints(pl) {
            return pl * crusadeData.pointsPerPowerLevel;
        }

        // CRUD Operations for Units
        function createNewUnit() {
            try {
                const newUnit = {
                    id: generateUnitId(),
                    name: 'New Unit',
                    faction: '',
                    subfaction: '',
                    pointsCost: 0,
                    powerLevel: 0,
                    xp: 0,
                    crusadeRank: 'Fresh',
                    battlesPlayed: 0,
                    battlesWon: 0,
                    battlesSurvived: 0,
                    enemiesDestroyed: 0,
                    psychicPowersManifested: 0,
                    rangedWeapons: [],
                    meleeWeapons: [],
                    battleTraits: [],
                    battleScars: [],
                    agendas: [],
                    honors: '',
                    scars: '',
                    notes: '',
                    unitType: 'Troops',
                    models: 5,
                    leadership: 7,
                    movement: 6,
                    toughness: 4,
                    wounds: 1,
                    save: '3+',
                    isWarlord: false,
                    warlordTrait: null,
                    crusadeRelic: null,
                    status: 'active',
                    createdAt: new Date().toISOString()
                };
                
                crusadeData.units.push(newUnit);
                selectUnit(newUnit.id);
                renderUnitsGrid();
                switchTab('details');
                autoSave();
                showNotification('New unit created successfully!', 'success');
            } catch (error) {
                console.error("Error in createNewUnit:", error);
                showNotification('Error creating new unit.', 'error');
            }
        }

        function deleteUnit(unitId) {
            try {
                if (!confirm('Are you sure you want to permanently delete this unit? This cannot be undone.')) {
                    return;
                }
                
                const unitToDelete = crusadeData.units.find(function(unit) {
                    return unit.id === unitId;
                });
                
                crusadeData.units = crusadeData.units.filter(function(unit) {
                    return unit.id !== unitId;
                });

                if (crusadeData.warlord === unitId) {
                    crusadeData.warlord = null;
                }
                
                if (crusadeData.currentUnitId === unitId) {
                    crusadeData.currentUnitId = null;
                    clearUnitViews();
                }
                
                renderUnitsGrid();
                updateArmyStats();
// Update tracking mode text indicator
const trackingModeText = document.getElementById('tracking-mode-text');
if (trackingModeText) {
    if (crusadeData.trackByPoints) {
        trackingModeText.textContent = 'Points';
        trackingModeText.style.color = '#3b82f6'; // Blue for Points
    } else {
        trackingModeText.textContent = 'Power Level';
        trackingModeText.style.color = '#ffd700'; // Yellow for PL
    }
}
                autoSave();
                showNotification('Unit "' + (unitToDelete ? unitToDelete.name : 'Unnamed Unit') + '" deleted successfully.', 'success');
            } catch (error) {
                console.error("Error in deleteUnit:", error);
                showNotification('Error deleting unit.', 'error');
            }
        }

        function markUnitDestroyed(unitId) {
            const unit = crusadeData.units.find(u => u.id === unitId);
            if (!unit) return;

            if (unit.status === 'destroyed') {
                showNotification(`${unit.name} is already destroyed.`, 'info');
                return;
            }

            if (!confirm(`Are you sure you want to mark ${unit.name} as DESTROYED? It will be removed from your active force.`)) {
                return;
            }

            unit.status = 'destroyed';
            if (crusadeData.warlord === unit.id) {
                unit.isWarlord = false;
                unit.warlordTrait = null;
                unit.crusadeRelic = null;
                crusadeData.warlord = null;
                showNotification(`${unit.name} was your Warlord and has been demoted due to destruction.`, 'info');
            }

            renderUnitsGrid();
            updateArmyStats();
            if (crusadeData.currentUnitId === unit.id) {
                crusadeData.currentUnitId = null;
                clearUnitViews();
                switchTab('units');
            }
            autoSave();
            showNotification(`${unit.name} has been marked as DESTROYED.`, 'success');
            addArmyRP(0, `Unit "${unit.name}" marked as destroyed.`, unit.id);
        }

        function selectUnit(unitId) {
            try {
                const selectedUnit = crusadeData.units.find(u => u.id === unitId);
                if (selectedUnit && selectedUnit.status === 'destroyed') {
                    showNotification(`${selectedUnit.name} is destroyed. Use Combat Revival to restore it.`, 'info');
                    switchTab('requisition');
                    crusadeData.currentUnitId = null;
                    clearUnitViews();
                    renderUnitsGrid();
                    return;
                }

                crusadeData.currentUnitId = unitId;
                renderUnitsGrid();
                renderUnitDetails();
                renderUnitWeapons();
                renderUnitProgress();
                renderUnitTraits();
                renderRequisitionTracker();
                autoSave();
            } catch (error) {
                console.error("Error in selectUnit:", error);
                showNotification('Error selecting unit.', 'error');
            }
        }

        function updateCurrentUnit(field, value) {
            try {
                const currentUnit = getCurrentUnit();
                if (currentUnit && currentUnit.status === 'active') {
                    if (['pointsCost', 'powerLevel', 'battlesPlayed', 'battlesWon', 'battlesSurvived', 'enemiesDestroyed', 'psychicPowersManifested', 'models', 'leadership', 'movement', 'toughness', 'wounds'].includes(field)) {
                        const numericValue = parseInt(value) || 0;
                        if (field === 'pointsCost') {
                            currentUnit.pointsCost = numericValue;
                            // Update Power Level based on new pointsCost
                            currentUnit.powerLevel = convertPointsToPL(numericValue);
                        } else if (field === 'powerLevel') {
                            currentUnit.powerLevel = numericValue;
                            // Update Points Cost based on new powerLevel
                            currentUnit.pointsCost = convertPLToPoints(numericValue);
                        } else {
                            currentUnit[field] = numericValue;
                        }
                    } else if (field === 'isWarlord') {
                        if (value) {
                            if (crusadeData.warlord && crusadeData.warlord !== currentUnit.id) {
                                const oldWarlord = crusadeData.units.find(u => u.id === crusadeData.warlord);
                                if (oldWarlord) {
                                    oldWarlord.isWarlord = false;
                                    oldWarlord.warlordTrait = null;
                                    oldWarlord.crusadeRelic = null;
                                    showNotification(`Demoted ${oldWarlord.name} from Warlord status.`, 'info');
                                }
                            }
                            crusadeData.warlord = currentUnit.id;
                            currentUnit.isWarlord = true;
                            showNotification(`${currentUnit.name} is now your Army Warlord!`, 'success');
                        } else {
                            currentUnit.isWarlord = false;
                            currentUnit.warlordTrait = null;
                            currentUnit.crusadeRelic = null;
                            if (crusadeData.warlord === currentUnit.id) {
                                crusadeData.warlord = null;
                                showNotification(`${currentUnit.name} is no longer your Army Warlord.`, 'info');
                            }
                        }
                    }
                    else {
                        currentUnit[field] = value;
                    }
                    
                    if (field !== 'xp') {
                        currentUnit.crusadeRank = getCrusadeRank(currentUnit.xp || 0).name;
                    }
                    
                    renderUnitsGrid();
                    renderUnitDetails(); // Re-render to update UI with new calculated value
                    renderUnitProgress();
                    updateArmyStats();
                    autoSave();
                } else if (currentUnit && currentUnit.status === 'destroyed') {
                    showNotification('Cannot edit a destroyed unit. Revive it first.', 'warning');
                }
            } catch (error) {
                console.error("Error in updateCurrentUnit:", error);
                showNotification('Error updating unit.', 'error');
            }
        }

        function updateFaction(value) {
            try {
                const currentUnit = getCurrentUnit();
                if (currentUnit && currentUnit.status === 'active') {
                    currentUnit.faction = value;
                    currentUnit.subfaction = '';
                    renderUnitDetails();
                    renderUnitsGrid();
                    autoSave();
                } else if (currentUnit && currentUnit.status === 'destroyed') {
                    showNotification('Cannot edit a destroyed unit. Revive it first.', 'warning');
                }
            } catch (error) {
                console.error("Error in updateFaction:", error);
            }
        }

        function updateSubfaction(value) {
            try {
                const currentUnit = getCurrentUnit();
                if (currentUnit && currentUnit.status === 'active') {
                    currentUnit.subfaction = value;
                    renderUnitsGrid();
                    autoSave();
                } else if (currentUnit && currentUnit.status === 'destroyed') {
                    showNotification('Cannot edit a destroyed unit. Revive it first.', 'warning');
                }
            } catch (error) {
                console.error("Error in updateSubfaction:", error);
            }
        }

        function toggleFactionMode() {
            try {
                const currentUnit = getCurrentUnit();
                if (currentUnit && currentUnit.status === 'destroyed') {
                    showNotification('Cannot edit a destroyed unit. Revive it first.', 'warning');
                    return;
                }

                const factionSelect = document.getElementById('faction-select');
                const subfactionSelect = document.getElementById('subfaction-select');
                const factionInput = document.getElementById('faction-input');
                const subfactionInput = document.getElementById('subfaction-input');
                const toggleBtn = document.getElementById('faction-toggle');
                
                const isManualMode = factionSelect.style.display === 'none';
                
                if (isManualMode) {
                    factionSelect.style.display = 'block';
                    subfactionSelect.style.display = 'block';
                    factionInput.style.display = 'none';
                    subfactionInput.style.display = 'none';
                    toggleBtn.textContent = '‚úèÔ∏è Manual';
                    if (currentUnit) {
                        factionSelect.value = currentUnit.faction || '';
                        factionSelect.dispatchEvent(new Event('change'));
                        subfactionSelect.value = currentUnit.subfaction || '';
                    }
                } else {
                    factionSelect.style.display = 'none';
                    subfactionSelect.style.display = 'none';
                    factionInput.style.display = 'block';
                    subfactionInput.style.display = 'block';
                    toggleBtn.textContent = 'üìã List';
                    if (currentUnit) {
                        factionInput.value = currentUnit.faction || '';
                        subfactionInput.value = currentUnit.subfaction || '';
                    }
                }
            } catch (error) {
                console.error("Error in toggleFactionMode:", error);
            }
        }

        function renderSubfactionOptions(selectedFaction) {
            try {
                const subfactions = factionData[selectedFaction] || {};
                let html = '<option value="">Select Subfaction</option>';
                Object.keys(subfactions).forEach(function(subfaction) {
                    html += '<option value="' + subfaction + '">' + subfaction + '</option>';
                });
                return html;
            } catch (error) {
                console.error("Error in renderSubfactionOptions:", error);
                return '<option value="">Error loading subfactions</option>';
            }
        }

        function getUnitDisplayName(unit) {
            return unit.subfaction || unit.faction || 'No Faction';
        }

        function renderUnitsGrid() {
            try {
                const grid = document.getElementById('units-grid');
                if (!grid) {
                    console.warn("Element 'units-grid' not found for rendering.");
                    return;
                }
                
                grid.innerHTML = '';

                const addCard = document.createElement('div');
                addCard.className = 'add-unit-card';
                addCard.innerHTML = '<span class="add-icon">‚ûï</span><span>Add New Unit</span>';
                addCard.addEventListener('click', createNewUnit);
                grid.appendChild(addCard);

                const sortedUnits = [...crusadeData.units].sort((a, b) => {
                    if (a.status === 'destroyed' && b.status !== 'destroyed') return 1;
                    if (a.status !== 'destroyed' && b.status === 'destroyed') return -1;
                    return (a.name || '').localeCompare(b.name || '');
                });

                sortedUnits.forEach(function(unit) {
                    const unitCard = document.createElement('div');
                    unitCard.className = 'unit-card';
                    if (unit.id === crusadeData.currentUnitId && unit.status !== 'destroyed') {
                        unitCard.classList.add('selected');
                    }
                    if (unit.status === 'destroyed') {
                        unitCard.classList.add('destroyed');
                    }
                    
                    const rank = getCrusadeRank(unit.xp || 0);
                    
                    unitCard.innerHTML = 
                        (unit.status === 'destroyed' ? '<span class="destroyed-label">DESTROYED</span>' : '<span class="rank-badge ' + rank.class + '">' + rank.name + '</span>') +
                        '<button class="delete-unit" data-unit-id="' + unit.id + '">‚úñ</button>' +
                        '<div class="unit-name">' + (unit.name || 'Unnamed Unit') + (unit.isWarlord ? ' <span style="font-size: 0.8em; color: #8b5cf6;">(Warlord)</span>' : '') + '</div>' +
                        '<div class="unit-faction">' + getUnitDisplayName(unit) + '</div>' +
                        '<div class="unit-stats">' +
                            '<div class="stat-item"><span class="stat-label">CP:</span><span class="stat-value">' + (unit.pointsCost || 0) + '</span></div>' +
                            '<div class="stat-item"><span class="stat-label">PL:</span><span class="stat-value">' + (unit.powerLevel || 0) + '</span></div>' +
                            '<div class="stat-item"><span class="stat-label">XP:</span><span class="stat-value">' + (unit.xp || 0) + '</span></div>' +
                            '<div class="stat-item"><span class="stat-label">Battles:</span><span class="stat-value">' + (unit.battlesPlayed || 0) + ' / ' + (unit.battlesWon || 0) + '</span></div>' +
                        '</div>';
                    
                    unitCard.addEventListener('click', function() { selectUnit(unit.id); });

                    const deleteBtn = unitCard.querySelector('.delete-unit');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', function(event) {
                            event.stopPropagation();
                            deleteUnit(unit.id);
                        });
                    }

                    grid.appendChild(unitCard);
                });
            } catch (error) {
                console.error("Error in renderUnitsGrid:", error);
            }
        }

        function renderUnitDetails() {
            try {
                const container = document.getElementById('unit-details-content');
                if (!container) {
                    console.warn("Element 'unit-details-content' not found for rendering.");
                    return;
                }
                const currentUnit = getCurrentUnit();
                
                if (!currentUnit) {
                    container.innerHTML = 
                        '<div class="no-unit-selected">' +
                            '<h3>No Unit Selected</h3>' +
                            '<p>Select a unit from the Units tab to view and edit its details.</p>' +
                        '</div>';
                    return;
                }

                let factionOptions = '';
                Object.keys(factionData).forEach(function(faction) {
                    const selected = currentUnit.faction === faction ? ' selected' : '';
                    factionOptions += '<option value="' + faction + '"' + selected + '>' + faction + '</option>';
                });

                let subfactionOptions = renderSubfactionOptions(currentUnit.faction);
                const selectedSubfaction = currentUnit.subfaction || '';
                subfactionOptions = subfactionOptions.replace('value="' + selectedSubfaction + '"', 'value="' + selectedSubfaction + '" selected');

                const unitTypeOptions = ['HQ', 'Troops', 'Elites', 'Fast Attack', 'Heavy Support', 'Flyer', 'Dedicated Transport', 'Fortification', 'Lord of War'].map(function(type) {
                    const selected = currentUnit.unitType === type ? ' selected' : '';
                    return '<option value="' + type + '"' + selected + '>' + type + '</option>';
                }).join('');

                const rank = getCrusadeRank(currentUnit.xp || 0);

                const isCharacter = currentUnit.unitType === 'HQ';

                let warlordSpecificHtml = '';
                if (isCharacter) {
                    let warlordTraitOptions = '<option value="">Select Warlord Trait...</option>';
                    Object.keys(warlordTraits).forEach(category => {
                        warlordTraitOptions += `<optgroup label="${category}">`;
                        Object.keys(warlordTraits[category]).forEach(traitName => {
                            const trait = warlordTraits[category][traitName];
                            const selected = currentUnit.warlordTrait && currentUnit.warlordTrait.name === traitName ? ' selected' : '';
                            warlordTraitOptions += `<option value="${traitName}"${selected}>${traitName} (Cost: ${trait.cost} RP)</option>`;
                        });
                        warlordTraitOptions += `</optgroup>`;
                    });

                    let crusadeRelicOptions = '<option value="">Select Crusade Relic...</option>';
                    Object.keys(crusadeRelics).forEach(category => {
                        crusadeRelicOptions += `<optgroup label="${category}">`; 
                        Object.keys(crusadeRelics[category]).forEach(relicName => {
                            const relic = crusadeRelics[category][relicName]; 
                            const selected = currentUnit.crusadeRelic && currentUnit.crusadeRelic.name === relicName ? ' selected' : '';
                            crusadeRelicOptions += `<option value="${relicName}"${selected}>${relicName} (Cost: ${relic.cost} RP)</option>`;
                        });
                        crusadeRelicOptions += `</optgroup>`;
                    });

                    warlordSpecificHtml = `
                        <div class="card">
                            <h2>Warlord & Relics</h2>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Is Army Warlord?</label>
                                    <input type="checkbox" id="detail-is-warlord-input" ${currentUnit.isWarlord ? 'checked' : ''} ${currentUnit.status === 'destroyed' ? 'disabled' : ''}>
                                </div>
                                <div class="form-group">
                                    <label for="detail-warlord-trait-select">Warlord Trait</label>
                                    <select id="detail-warlord-trait-select" ${currentUnit.status === 'destroyed' ? 'disabled' : ''}>
                                        ${warlordTraitOptions}
                                    </select>
                                    <div id="warlord-trait-description" class="rule-description"></div>
                                </div>
                                <div class="form-group">
                                    <label for="detail-crusade-relic-select">Crusade Relic</label>
                                    <select id="detail-crusade-relic-select" ${currentUnit.status === 'destroyed' ? 'disabled' : ''}>
                                        ${crusadeRelicOptions}
                                    </select>
                                    <div id="crusade-relic-description" class="rule-description"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                const disabledAttribute = currentUnit.status === 'destroyed' ? 'disabled' : '';

                container.innerHTML = 
                    '<div class="current-unit-info">' +
                        '<h3>Editing: ' + (currentUnit.name || 'Unnamed Unit') + '</h3>' +
                        '<span class="crusade-rank ' + rank.class + '">' + rank.name + ' (' + (currentUnit.xp || 0) + ' XP)</span>' +
                        (currentUnit.status === 'destroyed' ? '<span class="destroyed-label" style="position: static; margin-left: 10px;">DESTROYED</span>' : '') +
                    '</div>' +
                    '<div class="card">' +
                        '<h2>Unit Information</h2>' +
                        '<div class="form-grid">' +
                            '<div class="form-group">' +
                                '<label>Name</label>' +
                                '<input type="text" id="detail-unit-name-input" value="' + (currentUnit.name || '') + '" placeholder="Enter unit name" ' + disabledAttribute + '>' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label>Unit Type</label>' +
                                '<select id="detail-unit-type-select" ' + disabledAttribute + '>' +
                                    unitTypeOptions +
                                '</select>' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label>Faction & Subfaction</label>' +
                                '<div class="faction-row">' +
                                    '<select id="faction-select" ' + disabledAttribute + '>' +
                                        '<option value="">Select Faction</option>' +
                                        factionOptions +
                                    '</select>' +
                                    '<select id="subfaction-select" ' + disabledAttribute + '>' +
                                        subfactionOptions +
                                    '</select>' +
                                    '<input type="text" id="faction-input" value="' + (currentUnit.faction || '') + '" placeholder="Custom faction" style="display: none;" ' + disabledAttribute + '>' +
                                    '<input type="text" id="subfaction-input" value="' + (currentUnit.subfaction || '') + '" placeholder="Custom subfaction" style="display: none;" ' + disabledAttribute + '>' +
                                    '<button type="button" id="faction-toggle" class="faction-toggle" ' + disabledAttribute + '>‚úèÔ∏è Manual</button>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="card">' +
                        '<h2>Cost & Models</h2>' +
                        '<div class="form-grid">' +
                            '<div class="form-group">' +
                                '<label id="points-cost-label">Points Cost</label>' +
                                '<input type="number" id="detail-points-cost-input" value="' + (currentUnit.pointsCost || 0) + '" placeholder="0" min="0" ' + (crusadeData.trackByPoints ? '' : 'readonly') + ' ' + disabledAttribute + '>' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label id="power-level-label">Power Level</label>' +
                                '<input type="number" id="detail-power-level-input" value="' + (currentUnit.powerLevel || 0) + '" placeholder="0" min="0" ' + (!crusadeData.trackByPoints ? '' : 'readonly') + ' ' + disabledAttribute + '>' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label>Number of Models</label>' +
                                '<input type="number" id="detail-models-input" value="' + (currentUnit.models || 1) + '" placeholder="1" min="1" ' + disabledAttribute + '>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="card">' +
                        '<h2>Unit Statistics</h2>' +
                        '<div class="form-grid">' +
                            '<div class="form-group">' +
                                '<label>Movement</label>' +
                                '<input type="number" id="detail-movement-input" value="' + (currentUnit.movement || 6) + '" placeholder="6" min="1" ' + disabledAttribute + '>' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label>Toughness</label>' +
                                '<input type="number" id="detail-toughness-input" value="' + (currentUnit.toughness || 4) + '" placeholder="4" min="1" ' + disabledAttribute + '>' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label>Wounds</label>' +
                                '<input type="number" id="detail-wounds-input" value="' + (currentUnit.wounds || 1) + '" placeholder="1" min="1" ' + disabledAttribute + '>' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label>Leadership</label>' +
                                '<input type="number" id="detail-leadership-input" value="' + (currentUnit.leadership || 7) + '" placeholder="7" min="1" max="10" ' + disabledAttribute + '>' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label>Save</label>' +
                                '<input type="text" id="detail-save-input" value="' + (currentUnit.save || '3+') + '" placeholder="3+" ' + disabledAttribute + '>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    warlordSpecificHtml;

                if (currentUnit.status === 'active') {
                    document.getElementById('detail-unit-name-input').addEventListener('change', function() { updateCurrentUnit('name', this.value); });
                    document.getElementById('detail-unit-type-select').addEventListener('change', function() { updateCurrentUnit('unitType', this.value); });
                    
                    document.getElementById('detail-unit-type-select').addEventListener('change', function() {
                        updateCurrentUnit('unitType', this.value);
                        renderUnitDetails();
                    });

                    document.getElementById('faction-select').addEventListener('change', function() { updateFaction(this.value); });
                    document.getElementById('subfaction-select').addEventListener('change', function() { updateSubfaction(this.value); });
                    document.getElementById('faction-input').addEventListener('change', function() { updateCurrentUnit('faction', this.value); });
                    document.getElementById('subfaction-input').addEventListener('change', function() { updateCurrentUnit('subfaction', this.value); });
                    document.getElementById('faction-toggle').addEventListener('click', toggleFactionMode);
                    
                    document.getElementById('detail-points-cost-input').addEventListener('change', function() { updateCurrentUnit('pointsCost', this.value); });
                    document.getElementById('detail-power-level-input').addEventListener('change', function() { updateCurrentUnit('powerLevel', this.value); });
                    
                    document.getElementById('detail-models-input').addEventListener('change', function() { updateCurrentUnit('models', this.value); });
                    document.getElementById('detail-movement-input').addEventListener('change', function() { updateCurrentUnit('movement', this.value); });
                    document.getElementById('detail-toughness-input').addEventListener('change', function() { updateCurrentUnit('toughness', this.value); });
                    document.getElementById('detail-wounds-input').addEventListener('change', function() { updateCurrentUnit('wounds', this.value); });
                    document.getElementById('detail-leadership-input').addEventListener('change', function() { updateCurrentUnit('leadership', this.value); });
                    document.getElementById('detail-save-input').addEventListener('change', function() { updateCurrentUnit('save', this.value); });

                    if (isCharacter) {
                        const warlordCheckbox = document.getElementById('detail-is-warlord-input');
                        const warlordTraitSelect = document.getElementById('detail-warlord-trait-select');
                        const crusadeRelicSelect = document.getElementById('detail-crusade-relic-select');
                        const warlordTraitDescriptionDiv = document.getElementById('warlord-trait-description');
                        const crusadeRelicDescriptionDiv = document.getElementById('crusade-relic-description');


                        if (warlordCheckbox) {
                            warlordCheckbox.addEventListener('change', function() { updateCurrentUnit('isWarlord', this.checked); });
                        }
                        if (warlordTraitSelect) {
                            if (currentUnit.warlordTrait) {
                                const traitDetail = findTraitDetail(currentUnit.warlordTrait.name);
                                if (traitDetail) {
                                    warlordTraitDescriptionDiv.textContent = traitDetail.description;
                                    warlordTraitDescriptionDiv.classList.add('active');
                                }
                            }

                            warlordTraitSelect.addEventListener('change', function() {
                                const traitName = this.value;
                                const traitData = traitName ? findTraitDetail(traitName) : null;
                                const currentUnit = getCurrentUnit();
                                if (!currentUnit) return;

                                if (traitData) {
                                    let costDifference = traitData.cost || 0;
                                    if (currentUnit.warlordTrait) {
                                        costDifference -= currentUnit.warlordTrait.cost || 0;
                                    }

                                    if (costDifference > 0 && !deductArmyRP(costDifference, `Purchase Warlord Trait "${traitData.name}" for ${currentUnit.name}`, currentUnit.id)) {
                                        this.value = currentUnit.warlordTrait ? currentUnit.warlordTrait.name : '';
                                        const originalTraitDetail = currentUnit.warlordTrait ? findTraitDetail(currentUnit.warlordTrait.name) : null;
                                        warlordTraitDescriptionDiv.textContent = originalTraitDetail ? originalTraitDetail.description : '';
                                        warlordTraitDescriptionDiv.classList.toggle('active', !!originalTraitDetail);
                                        return;
                                    } else if (costDifference < 0) {
                                        addArmyRP(Math.abs(costDifference), `Refund for changing Warlord Trait for ${currentUnit.name}`, currentUnit.id);
                                    }
                                    currentUnit.warlordTrait = { name: traitData.name, cost: traitData.cost, description: traitData.description };
                                    warlordTraitDescriptionDiv.textContent = traitData.description;
                                    warlordTraitDescriptionDiv.classList.add('active');
                                } else {
                                    if (currentUnit.warlordTrait) {
                                        addArmyRP(currentUnit.warlordTrait.cost || 0, `Refund for removing Warlord Trait from ${currentUnit.name}`, currentUnit.id);
                                    }
                                    currentUnit.warlordTrait = null;
                                    warlordTraitDescriptionDiv.textContent = '';
                                    warlordTraitDescriptionDiv.classList.remove('active');
                                }
                                autoSave();
                                showNotification(`Warlord Trait for ${currentUnit.name} updated.`, 'success');
                            });
                        }
                        if (crusadeRelicSelect) {
                            if (currentUnit.crusadeRelic) {
                                const relicDetail = findRelicDetail(currentUnit.crusadeRelic.name);
                                if (relicDetail) {
                                    crusadeRelicDescriptionDiv.textContent = relicDetail.description;
                                    crusadeRelicDescriptionDiv.classList.add('active');
                                }
                            }

                            crusadeRelicSelect.addEventListener('change', function() {
                                const relicName = this.value;
                                const relicData = relicName ? findRelicDetail(relicName) : null;
                                const currentUnit = getCurrentUnit();
                                if (!currentUnit) return;

                                if (relicData) {
                                    const existingRelicBearer = crusadeData.units.find(u => 
                                        u.id !== currentUnit.id && 
                                        u.status === 'active' && 
                                        u.crusadeRelic && 
                                        u.crusadeRelic.name === relicData.name
                                    );

                                    if (existingRelicBearer) {
                                        if (!confirm(`"${relicData.name}" is already assigned to ${existingRelicBearer.name}. Do you want to move it to ${currentUnit.name}? This will remove it from ${existingRelicBearer.name}.`)) {
                                            this.value = currentUnit.crusadeRelic ? currentUnit.crusadeRelic.name : '';
                                            const originalRelicDetail = currentUnit.crusadeRelic ? findRelicDetail(currentUnit.crusadeRelic.name) : null;
                                            crusadeRelicDescriptionDiv.textContent = originalRelicDetail ? originalRelicDetail.description : '';
                                            crusadeRelicDescriptionDiv.classList.toggle('active', !!originalRelicDetail);
                                            return;
                                        } else {
                                            if (existingRelicBearer.crusadeRelic) {
                                                addArmyRP(existingRelicBearer.crusadeRelic.cost || 0, `Refund for moving Crusade Relic "${existingRelicBearer.crusadeRelic.name}" from ${existingRelicBearer.name}`, existingRelicBearer.id);
                                            }
                                            existingRelicBearer.crusadeRelic = null;
                                            showNotification(`"${relicData.name}" removed from ${existingRelicBearer.name}.`, 'info');
                                            renderUnitsGrid();
                                        }
                                    }

                                    let costDifference = relicData.cost || 0;
                                    if (currentUnit.crusadeRelic) {
                                        costDifference -= currentUnit.crusadeRelic.cost || 0;
                                    }

                                    if (costDifference > 0 && !deductArmyRP(costDifference, `Purchase Crusade Relic "${relicData.name}" for ${currentUnit.name}`, currentUnit.id)) {
                                        this.value = currentUnit.crusadeRelic ? currentUnit.crusadeRelic.name : '';
                                        const originalRelicDetail = currentUnit.crusadeRelic ? findRelicDetail(currentUnit.crusadeRelic.name) : null;
                                        crusadeRelicDescriptionDiv.textContent = originalRelicDetail ? originalRelicDetail.description : '';
                                        crusadeRelicDescriptionDiv.classList.toggle('active', !!originalRelicDetail);
                                        return;
                                    } else if (costDifference < 0) {
                                        addArmyRP(Math.abs(costDifference), `Refund for changing Crusade Relic for ${currentUnit.name}`, currentUnit.id);
                                    }
                                    currentUnit.crusadeRelic = { name: relicData.name, cost: relicData.cost, description: relicData.description };
                                    crusadeRelicDescriptionDiv.textContent = relicData.description;
                                    crusadeRelicDescriptionDiv.classList.add('active');
                                } else {
                                    if (currentUnit.crusadeRelic) {
                                        addArmyRP(currentUnit.crusadeRelic.cost || 0, `Refund for removing Crusade Relic from ${currentUnit.name}`, currentUnit.id);
                                    }
                                    currentUnit.crusadeRelic = null;
                                    crusadeRelicDescriptionDiv.textContent = '';
                                    crusadeRelicDescriptionDiv.classList.remove('active');
                                }
                                autoSave();
                                showNotification(`Crusade Relic for ${currentUnit.name} updated.`, 'success');
                            });
                        }
                    }
                }
                // Update visibility and labels based on tracking mode
                const pointsCostInput = document.getElementById('detail-points-cost-input');
                const powerLevelInput = document.getElementById('detail-power-level-input');
                const pointsCostLabel = document.getElementById('points-cost-label');
                const powerLevelLabel = document.getElementById('power-level-label');

                if (crusadeData.trackByPoints) {
                    pointsCostInput.removeAttribute('readonly');
                    pointsCostInput.style.cssText += 'cursor: auto; background-color: #1a1a2e;';
                    powerLevelInput.setAttribute('readonly', 'readonly');
                    powerLevelInput.style.cssText += 'cursor: not-allowed; background-color: #333;';
                    pointsCostLabel.textContent = 'Points Cost';
                    powerLevelLabel.textContent = 'Power Level (Calculated)';
                } else {
                    pointsCostInput.setAttribute('readonly', 'readonly');
                    pointsCostInput.style.cssText += 'cursor: not-allowed; background-color: #333;';
                    powerLevelInput.removeAttribute('readonly');
                    powerLevelInput.style.cssText += 'cursor: auto; background-color: #1a1a2e;';
                    pointsCostLabel.textContent = 'Points Cost (Calculated)';
                    powerLevelLabel.textContent = 'Power Level';
                }

            } catch (error) {
                console.error("Error in renderUnitDetails:", error);
                showNotification('Error rendering unit details.', 'error');
            }
        }

        function findTraitDetail(traitName) {
            for (const category in warlordTraits) {
                if (warlordTraits[category][traitName]) {
                    return warlordTraits[category][traitName];
                }
            }
            return null;
        }

        function findRelicDetail(relicName) {
            for (const category in crusadeRelics) {
                if (crusadeRelics[category][relicName]) {
                    return crusadeRelics[category][relicName];
                }
            }
            return null;
        }

        function renderUnitWeapons() {
            try {
                const container = document.getElementById('weapons-content');
                if (!container) {
                    console.warn("Element 'weapons-content' not found for rendering.");
                    return;
                }
                const currentUnit = getCurrentUnit();
                
                if (!currentUnit) {
                    container.innerHTML = 
                        '<div class="no-unit-selected">' +
                            '<h3>No Unit Selected</h3>' +
                            '<p>Select a unit from the Units tab to manage its weapons.</p>' +
                        '</div>';
                    return;
                }
                if (currentUnit.status === 'destroyed') {
                    container.innerHTML = '<div class="no-unit-selected"><h3>Unit Destroyed</h3><p>This unit is destroyed and cannot be edited. Revive it first.</p></div>';
                    return;
                }

                if (!currentUnit.rangedWeapons) currentUnit.rangedWeapons = [];
                if (!currentUnit.meleeWeapons) currentUnit.meleeWeapons = [];

                container.innerHTML = 
                    '<div class="current-unit-info">' +
                        '<h3>Weapons for: ' + (currentUnit.name || 'Unnamed Unit') + '</h3>' +
                    '</div>' +
                    '<div class="card">' +
                        '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">' +
                            '<h2>‚öîÔ∏è Ranged Weapons</h2>' +
                            '<div class="weapon-template-selector">' +
                                '<div class="form-group template-dropdown">' +
                                    '<label for="ranged-template-select">Add Ranged Template</label>' +
                                    '<select id="ranged-template-select">' +
                                        '<option value="">Choose Template...</option>' +
                                        renderWeaponTemplateOptions('ranged') +
                                    '</select>' +
                                '</div>' +
                                '<button class="btn btn-info btn-small" id="add-ranged-template-btn">üìã Add Template</button>' +
                                '<button class="btn btn-primary btn-small" id="add-ranged-manual-btn">‚úèÔ∏è Manual</button>' +
                            '</div>' +
                        '</div>' +
                        '<div id="ranged-weapons-list">' +
                            renderWeapons(currentUnit.rangedWeapons, 'ranged') +
                        '</div>' +
                    '</div>' +
                    '<div class="card">' +
                        '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">' +
                            '<h2>üó°Ô∏è Melee Weapons</h2>' +
                            '<div class="weapon-template-selector">' +
                                '<div class="form-group template-dropdown">' +
                                    '<label for="melee-template-select">Add Melee Template</label>' +
                                    '<select id="melee-template-select">' +
                                        '<option value="">Choose Template...</option>' +
                                        renderWeaponTemplateOptions('melee') +
                                    '</select>' +
                                '</div>' +
                                '<button class="btn btn-info btn-small" id="add-melee-template-btn">üìã Add Template</button>' +
                                '<button class="btn btn-primary btn-small" id="add-melee-manual-btn">‚úèÔ∏è Manual</button>' +
                            '</div>' +
                        '</div>' +
                        '<div id="melee-weapons-list">' +
                            renderWeapons(currentUnit.meleeWeapons, 'melee') +
                        '</div>' +
                    '</div>';

                document.getElementById('add-ranged-template-btn').addEventListener('click', function() { addFromTemplate('ranged'); });
                document.getElementById('add-ranged-manual-btn').addEventListener('click', addRangedWeapon);
                document.getElementById('add-melee-template-btn').addEventListener('click', function() { addFromTemplate('melee'); });
                document.getElementById('add-melee-manual-btn').addEventListener('click', addMeleeWeapon);

            } catch (error) {
                console.error("Error in renderUnitWeapons:", error);
                showNotification('Error rendering unit weapons.', 'error');
            }
        }

        function renderWeaponTemplateOptions(type) {
            try {
                const templates = weaponTemplates[type] || {};
                let html = '';
                
                Object.keys(templates).forEach(function(category) {
                    html += '<optgroup label="' + category + '">';
                    Object.keys(templates[category]).forEach(function(weaponName) {
                        html += '<option value="' + category + '|' + weaponName + '">' + weaponName + '</option>';
                    });
                    html += '</optgroup>';
                });
                
                return html;
            } catch (error) {
                console.error("Error in renderWeaponTemplateOptions:", error);
                return '';
            }
        }

        function renderWeapons(weapons, type) {
            const currentUnit = getCurrentUnit();
            const disabledAttribute = (currentUnit && currentUnit.status === 'destroyed') ? 'disabled' : '';

            if (weapons.length === 0) {
                return '<div class="empty-state">No weapons added yet</div>';
            }
            
            let html = '';
            weapons.forEach(function(weapon, i) {
                const fields = type === 'ranged' 
                    ? ['name', 'range', 'attacks', 'bs', 'strength', 'ap', 'damage', 'abilities']
                    : ['name', 'ws', 'attacks', 'strength', 'ap', 'damage', 'abilities'];
                    
                const fieldLabels = type === 'ranged'
                    ? ['Name', 'Range', 'Attacks', 'BS', 'Strength', 'AP', 'Damage', 'Abilities']
                    : ['Name', 'WS', 'Attacks', 'Strength', 'AP', 'Damage', 'Abilities'];
                
                html += '<div class="weapon-item">' +
                    '<div class="weapon-header">' +
                        '<h3>' + (weapon.name || 'Weapon ' + (i + 1)) + '</h3>' +
                        '<button class="btn btn-danger btn-small delete-weapon-btn" data-type="' + type + '" data-index="' + i + '" ' + disabledAttribute + '>üóëÔ∏è</button>' +
                    '</div>' +
                    '<div class="weapon-grid">';
                
                fields.forEach(function(field, j) {
                    const label = fieldLabels[j];
                    const inputTag = field === 'abilities' ? 'textarea' : 'input';
                    const inputType = (field === 'attacks' || field === 'strength' || field === 'damage') ? 'text' : 'text';
                    
                    if (inputTag === 'textarea') {
                        html += '<div class="form-group" style="grid-column: 1 / -1;">' +
                            '<label>' + label + '</label>' +
                            '<textarea rows="2" class="weapon-input" data-type="' + type + '" data-index="' + i + '" data-field="' + field + '" ' +
                            'placeholder="Enter ' + label.toLowerCase() + '" ' + disabledAttribute + '>' + (weapon[field] || '') + '</textarea>' +
                        '</div>';
                    } else {
                        html += '<div class="form-group">' +
                            '<label>' + label + '</label>' +
                            '<input type="' + inputType + '" value="' + (weapon[field] || '') + '" ' +
                            'class="weapon-input" data-type="' + type + '" data-index="' + i + '" data-field="' + field + '" ' +
                            'placeholder="Enter ' + label.toLowerCase() + '" ' + disabledAttribute + '>' +
                        '</div>';
                    }
                });
                
                html += '</div></div>';
            });
            
            setTimeout(() => {
                if (currentUnit && currentUnit.status === 'active') {
                    document.querySelectorAll('.weapon-input').forEach(input => {
                        input.addEventListener('change', function() {
                            updateWeapon(this.dataset.type, parseInt(this.dataset.index), this.dataset.field, this.value);
                        });
                    });
                    document.querySelectorAll('.delete-weapon-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            removeWeapon(this.dataset.type, parseInt(this.dataset.index));
                        });
                    });
                }
            }, 0);

            return html;
        }

        function addFromTemplate(type) {
            try {
                const currentUnit = getCurrentUnit();
                if (currentUnit && currentUnit.status === 'destroyed') {
                    showNotification('Cannot add weapons to a destroyed unit. Revive it first.', 'warning');
                    return;
                }

                const selectId = type + '-template-select';
                const select = document.getElementById(selectId);
                const selectedValue = select.value;
                
                if (!selectedValue) {
                    showNotification('Please select a weapon template first.', 'warning');
                    return;
                }
                
                const [category, weaponName] = selectedValue.split('|');
                
                if (!category || !weaponName || !weaponTemplates[type][category] || !weaponTemplates[type][category][weaponName]) {
                    showNotification('Invalid weapon template selected.', 'error');
                    return;
                }

                const weapon = weaponTemplates[type][category][weaponName];
                addWeaponToUnit(type, weapon);
                select.value = '';
            } catch (error) {
                console.error("Error in addFromTemplate:", error);
                showNotification('Error adding weapon template.', 'error');
            }
        }

        function addWeaponToUnit(type, weaponData) {
            try {
                const currentUnit = getCurrentUnit();
                if (!currentUnit) {
                    showNotification('Please select a unit first to add weapons.', 'warning');
                    return;
                }
                
                const targetArray = type === 'ranged' ? currentUnit.rangedWeapons : currentUnit.meleeWeapons;
                
                if (targetArray.some(w => w.name === weaponData.name && w.name !== '')) {
                    showNotification(`${weaponData.name} is already added to this unit.`, 'warning');
                    return;
                }

                targetArray.push(JSON.parse(JSON.stringify(weaponData)));
                
                renderUnitWeapons();
                autoSave();
                showNotification('Added ' + (weaponData.name || 'new weapon') + ' to unit!', 'success');
            } catch (error) {
                console.error("Error in addWeaponToUnit:", error);
                showNotification('Error adding weapon to unit.', 'error');
            }
        }

        function addRangedWeapon() {
            addWeaponToUnit('ranged', {
                name: '', range: '', attacks: '', bs: '', strength: '', ap: '', damage: '', abilities: ''
            });
        }

        function addMeleeWeapon() {
            addWeaponToUnit('melee', {
                name: '', ws: '', attacks: '', strength: '', ap: '', damage: '', abilities: ''
            });
        }

        function removeWeapon(type, index) {
            try {
                const currentUnit = getCurrentUnit();
                if (!currentUnit || currentUnit.status === 'destroyed') {
                    showNotification('Cannot remove weapons from a destroyed unit. Revive it first.', 'warning');
                    return;
                }
                
                const targetArray = type === 'ranged' ? currentUnit.rangedWeapons : currentUnit.meleeWeapons;
                const removedWeaponName = targetArray[index] ? targetArray[index].name : 'weapon';

                targetArray.splice(index, 1);
                
                renderUnitWeapons();
                autoSave();
                showNotification('Removed ' + removedWeaponName + '.', 'success');
            } catch (error) {
                console.error("Error in removeWeapon:", error);
                showNotification('Error removing weapon.', 'error');
            }
        }

        function updateWeapon(type, index, field, value) {
            try {
                const currentUnit = getCurrentUnit();
                if (!currentUnit || currentUnit.status === 'destroyed') {
                    showNotification('Cannot edit weapons on a destroyed unit. Revive it first.', 'warning');
                    return;
                }
                
                const targetArray = type === 'ranged' ? currentUnit.rangedWeapons : currentUnit.meleeWeapons;
                if (!targetArray[index]) return;
                targetArray[index][field] = value;
                
                autoSave();
            } catch (error) {
                console.error("Error in updateWeapon:", error);
            }
        }

        function renderUnitProgress() {
            try {
                const container = document.getElementById('progress-content');
                if (!container) {
                    console.warn("Element 'progress-content' not found for rendering.");
                    return;
                }
                const currentUnit = getCurrentUnit();
                
                if (!currentUnit) {
                    container.innerHTML = 
                        '<div class="no-unit-selected">' +
                            '<h3>No Unit Selected</h3>' +
                            '<p>Select a unit from the Units tab to track its crusade progress.</p>' +
                        '</div>';
                    return;
                }

                currentUnit.battlesPlayed = currentUnit.battlesPlayed || 0;
                currentUnit.battlesWon = currentUnit.battlesWon || 0;
                currentUnit.battlesSurvived = currentUnit.battlesSurvived || 0;
                currentUnit.enemiesDestroyed = currentUnit.enemiesDestroyed || 0;
                currentUnit.psychicPowersManifested = currentUnit.psychicPowersManifested || 0;
                currentUnit.honors = currentUnit.honors || '';
                currentUnit.scars = currentUnit.scars || '';
                currentUnit.notes = currentUnit.notes || '';

                const winRate = currentUnit.battlesPlayed > 0 ? Math.round((currentUnit.battlesWon / currentUnit.battlesPlayed) * 100) : 0;
                const survivalRate = currentUnit.battlesPlayed > 0 ? Math.round((currentUnit.battlesSurvived / currentUnit.battlesPlayed) * 100) : 0;
                const rank = getCrusadeRank(currentUnit.xp || 0);

                const disabledAttribute = currentUnit.status === 'destroyed' ? 'disabled' : '';

                container.innerHTML = 
                    '<div class="current-unit-info">' +
                        '<h3>Progress for: ' + (currentUnit.name || 'Unnamed Unit') + '</h3>' +
                        '<span class="crusade-rank ' + rank.class + '">' + rank.name + ' (' + (currentUnit.xp || 0) + ' XP)</span>' +
                        (currentUnit.status === 'destroyed' ? '<span class="destroyed-label" style="position: static; margin-left: 10px;">DESTROYED</span>' : '') +
                    '</div>' +
                    '<div class="card">' +
                        '<h2>Unit Status</h2>' +
                        '<div style="margin-bottom: 1rem; color: #ccc;">Current Status: <strong>' + currentUnit.status.toUpperCase() + '</strong></div>' +
                        (currentUnit.status === 'active' ?
                        `<button class="btn btn-danger" id="mark-destroyed-btn">Mark as Destroyed</button>` :
                        `<p style="color: #ccc; margin-top: 1rem;">This unit is destroyed. Use "Combat Revival" in the Requisition tab to restore it.</p>`) +
                    '</div>' +
                    '<div class="card">' +
                        '<h2>Out of Action Roll</h2>' +
                        `<p style="color: #ccc; margin-bottom: 1rem;">If this unit was removed from the battlefield, perform an Out of Action test:</p>` +
                        `<button class="btn btn-purple" id="roll-ooa-btn" ${disabledAttribute}>Roll for Out of Action Result</button>` +
                    '</div>' +
                    '<div class="card">' +
                        '<h2>üìä Crusade Progress</h2>' +
                        '<div class="form-grid">' +
                            '<div class="form-group">' +
                                '<label>Experience Points</label>' +
                                '<input type="number" id="progress-xp-input" value="' + (currentUnit.xp || 0) + '" placeholder="0" min="0" ' + disabledAttribute + '>' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label>Battles Played</label>' +
                                '<input type="number" id="progress-battles-played-input" value="' + currentUnit.battlesPlayed + '" placeholder="0" min="0" ' + disabledAttribute + '>' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label>Battles Won</label>' +
                                '<input type="number" id="progress-battles-won-input" value="' + currentUnit.battlesWon + '" placeholder="0" min="0" ' + disabledAttribute + '>' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label>Battles Survived</label>' +
                                '<input type="number" id="progress-battles-survived-input" value="' + currentUnit.battlesSurvived + '" placeholder="0" min="0" ' + disabledAttribute + '>' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label>Enemies Destroyed</label>' +
                                '<input type="number" id="progress-enemies-destroyed-input" value="' + currentUnit.enemiesDestroyed + '" placeholder="0" min="0" ' + disabledAttribute + '>' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label>Psychic Powers Manifested</label>' +
                                '<input type="number" id="progress-psychic-powers-input" value="' + currentUnit.psychicPowersManifested + '" placeholder="0" min="0" ' + disabledAttribute + '>' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label>Win Rate</label>' +
                                '<div style="padding: 0.75rem; background: #1a1a2e; border: 2px solid #444; border-radius: 8px; text-align: center; color: #ffd700; font-weight: bold;">' +
                                    winRate + '%' +
                                '</div>' +
                            '</div>' +
                            '<div class="form-group">' +
                                '<label>Survival Rate</label>' +
                                '<div style="padding: 0.75rem; background: #1a1a2e; border: 2px solid #444; border-radius: 8px; text-align: center; color: #10b981; font-weight: bold;">' +
                                    survivalRate + '%' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="card">' +
                        '<h2>üèÜ Battle Honors</h2>' +
                        '<textarea rows="4" id="progress-honors-input" placeholder="Record battle honors and achievements..." style="width: 100%; resize: vertical;" ' + disabledAttribute + '>' + currentUnit.honors + '</textarea>' +
                    '</div>' +
                    '<div class="card">' +
                        '<h2>üíÄ Battle Scars</h2>' +
                        '<textarea rows="4" id="progress-scars-input" placeholder="Record battle scars and injuries..." style="width: 100%; resize: vertical;" ' + disabledAttribute + '>' + currentUnit.scars + '</textarea>' +
                    '</div>' +
                    '<div class="card">' +
                        '<h2>üìù Unit Notes</h2>' +
                        '<textarea rows="4" id="progress-notes-input" placeholder="Additional notes and lore for this unit..." style="width: 100%; resize: vertical;" ' + disabledAttribute + '>' + (currentUnit.notes || '') + '</textarea>' +
                    '</div>';

                if (currentUnit.status === 'active') {
                    document.getElementById('progress-xp-input').addEventListener('change', function() { 
                        const newXP = parseInt(this.value) || 0;
                        const currentUnit = getCurrentUnit();
                        if (currentUnit) {
                            const oldXP = currentUnit.xp || 0;
                            const xpDifference = newXP - oldXP;
                            if (xpDifference !== 0) {
                                applyXPToUnit(currentUnit.id, xpDifference);
                            }
                        }
                    });
                    document.getElementById('progress-battles-played-input').addEventListener('change', function() { updateCurrentUnit('battlesPlayed', this.value); });
                    document.getElementById('progress-battles-won-input').addEventListener('change', function() { updateCurrentUnit('battlesWon', this.value); });
                    document.getElementById('progress-battles-survived-input').addEventListener('change', function() { updateCurrentUnit('battlesSurvived', this.value); });
                    document.getElementById('progress-enemies-destroyed-input').addEventListener('change', function() { updateCurrentUnit('enemiesDestroyed', this.value); });
                    document.getElementById('progress-psychic-powers-input').addEventListener('change', function() { updateCurrentUnit('psychicPowersManifested', this.value); });
                    document.getElementById('progress-honors-input').addEventListener('change', function() { updateCurrentUnit('honors', this.value); });
                    document.getElementById('progress-scars-input').addEventListener('change', function() { updateCurrentUnit('scars', this.value); });
                    document.getElementById('progress-notes-input').addEventListener('change', function() { updateCurrentUnit('notes', this.value); });

                    document.getElementById('mark-destroyed-btn').addEventListener('click', function() {
                        markUnitDestroyed(currentUnit.id);
                    });

                    document.getElementById('roll-ooa-btn').addEventListener('click', function() {
                        showOutOfActionPrompt(currentUnit.id);
                    });
                }
            } catch (error) {
                console.error("Error in renderUnitProgress:", error);
                showNotification('Error rendering unit progress.', 'error');
            }
        }

        function renderUnitTraits() {
            try {
                const container = document.getElementById('traits-content');
                if (!container) {
                    console.warn("Element 'traits-content' not found for rendering.");
                    return;
                }
                const currentUnit = getCurrentUnit();
                
                if (!currentUnit) {
                    container.innerHTML = 
                        '<div class="no-unit-selected">' +
                            '<h3>No Unit Selected</h3>' +
                            '<p>Select a unit from the Units tab to manage its traits and scars.</p>' +
                        '</div>';
                    return;
                }
                if (currentUnit.status === 'destroyed') {
                    container.innerHTML = '<div class="no-unit-selected"><h3>Unit Destroyed</h3><p>This unit is destroyed and cannot be edited. Revive it first.</p></div>';
                    return;
                }

                if (!currentUnit.battleTraits) currentUnit.battleTraits = [];
                if (!currentUnit.battleScars) currentUnit.battleScars = [];

                const rank = getCrusadeRank(currentUnit.xp || 0);
                const disabledAttribute = currentUnit.status === 'destroyed' ? 'disabled' : '';

                container.innerHTML = 
                    '<div class="current-unit-info">' +
                        '<h3>Traits & Scars for: ' + (currentUnit.name || 'Unnamed Unit') + '</h3>' +
                        '<span class="crusade-rank ' + rank.class + '">' + rank.name + ' (' + (currentUnit.xp || 0) + ' XP)</span>' +
                    '</div>' +
                    '<div class="card">' +
                        '<h2>‚ú® Battle Traits</h2>' +
'<div class="form-group">' +
    '<label for="trait-category-select">Add Battle Trait</label>' +
    '<select id="trait-category-select" style="width: 250px;" ' + disabledAttribute + '>' +
        '<option value="">Choose Battle Honour...</option>' +
        renderBattleTraitOptions() + 
    '</select>' +
'</div>' +
                        // Manual Battle Trait Entry
                        '<div class="manual-entry-section">' +
                            '<h4>Manual Entry</h4>' +
                            '<div class="manual-entry-grid">' +
                                '<div class="form-group">' +
                                    '<label for="manual-trait-category-input">Category</label>' +
                                    '<input type="text" id="manual-trait-category-input" placeholder="e.g., Custom Traits" ' + disabledAttribute + '>' +
                                '</div>' +
                                '<div class="form-group">' +
                                    '<label for="manual-trait-name-input">Trait Name</label>' +
                                    '<input type="text" id="manual-trait-name-input" placeholder="e.g., Unstoppable" ' + disabledAttribute + '>' +
                                '</div>' +
                                '<div class="form-group">' +
                                    '<label for="manual-trait-cost-input">Trait Cost (RP)</label>' +
                                    '<input type="number" id="manual-trait-cost-input" value="0" min="0" placeholder="0" ' + disabledAttribute + '>' +
                                '</div>' +
                                '<div class="form-group" style="grid-column: 1 / -1; display: flex; align-items: flex-end;">' +
                                    '<button class="btn btn-primary btn-small" id="add-manual-trait-btn" ' + disabledAttribute + '>Add Trait</button>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        // End Manual Battle Trait Entry
                        '<div class="traits-section" id="current-unit-traits">' +
                            renderTraits(currentUnit.battleTraits, 'trait', disabledAttribute) +
                        '</div>' +
                    '</div>' +
                    '<div class="card">' +
                        '<h2>üíÄ Battle Scars</h2>' +
                        // Manual Battle Scar Entry
                        '<div class="form-group">' +
    '<label for="scar-category-select">Add Battle Scar</label>' +
    '<select id="scar-category-select" style="width: 250px;" ' + disabledAttribute + '>' +
        '<option value="">Choose Battle Scar...</option>' +
        renderBattleScarOptions() + 
    '</select>' +
'</div>' +
'<div class="manual-entry-section">' +
    '<h4>Manual Entry</h4>' +
    '<div class="manual-entry-section">' +
    '<h4>Manual Entry</h4>' +
    '<div class="manual-entry-grid">' +
        '<div class="form-group">' +
            '<label for="manual-scar-category-input">Category</label>' +
            '<input type="text" id="manual-scar-category-input" placeholder="e.g., Unique Scars" ' + disabledAttribute + '>' +
        '</div>' +
        '<div class="form-group">' +
            '<label for="manual-scar-name-input">Scar Name</label>' +
            '<input type="text" id="manual-scar-name-input" placeholder="e.g., Missing Eye" ' + disabledAttribute + '>' +
        '</div>' +
        '<div class="form-group" style="grid-column: 1 / -1; display: flex; align-items: flex-end;">' +
            '<button class="btn btn-primary btn-small" id="add-manual-scar-btn" ' + disabledAttribute + '>Add Scar</button>' +
        '</div>' +
    '</div>' +
'</div>' +
                        // End Manual Battle Scar Entry
                        '<div class="traits-section" id="current-unit-scars">' +
                            renderTraits(currentUnit.battleScars, 'scar', disabledAttribute) +
                        '</div>' +
                    '</div>';

                 if (currentUnit.status === 'active') {
                    // Manual Trait Event Listener (formerly addManualTraitBtn)
                    document.getElementById('add-manual-trait-btn').addEventListener('click', addManualBattleTrait);
// Battle Trait Dropdown Event Listener
    document.getElementById('trait-category-select').addEventListener('change', function() {
        if (this.value) {
            const [category, traitName] = this.value.split('|');
            addBattleTrait(category, traitName);
            this.value = '';
        }
    });

                    // Manual Scar Event Listener (formerly addManualScarBtn)
                    document.getElementById('scar-category-select').addEventListener('change', function() {
                        if (this.value) {
                            const [category, scarName] = this.value.split('|');
                            addBattleScar(category, scarName);
                            this.value = '';
                        }
                    });
//});
                    document.querySelectorAll('#current-unit-traits .delete-trait-btn').forEach(button => {
                        button.addEventListener('click', function() { removeTrait('trait', parseInt(this.dataset.index)); });
                    });
                    document.querySelectorAll('#current-unit-scars .delete-scar-btn').forEach(button => {
                        button.addEventListener('click', function() { removeTrait('scar', parseInt(this.dataset.index)); });
                    });
                }
            } catch (error) {
                console.error("Error in renderUnitTraits:", error);
                showNotification('Error rendering unit traits.', 'error');
            }
        }
function renderBattleScarOptions() {
    let html = '';
    Object.keys(battleScars).forEach(function(category) {
        html += '<optgroup label="' + category + '">';
        Object.keys(battleScars[category]).forEach(function(scarName) {
            html += '<option value="' + category + '|' + scarName + '">' + scarName + '</option>';
        });
        html += '</optgroup>';
    });
    return html;
}
function renderBattleTraitOptions() {
    let html = '';
    Object.keys(crusadeTraits).forEach(function(category) {
        html += '<optgroup label="' + category + '">';
        Object.keys(crusadeTraits[category]).forEach(function(traitName) {
            html += '<option value="' + category + '|' + traitName + '">' + traitName + '</option>';
        });
        html += '</optgroup>';
    });
    return html;
}
        function renderTraits(items, type, disabledAttribute) {
            if (items.length === 0) {
                return '<div class="empty-state">No ' + (type === 'trait' ? 'traits' : 'scars') + ' added yet</div>';
            }
            
            let html = '';
            items.forEach(function(item, i) {
                // If the trait/scar is manually added, it might not exist in the predefined lists,
                // so we use its own description if available, otherwise a generic one.
                const detail = (type === 'trait' ? crusadeTraits : battleScars)[item.category]?.[item.name];
                const description = detail ? detail.description : (item.description || 'Manually added entry.'); // Updated default description
                
                html += '<div class="trait-item">' +
                    '<div>' +
                        '<div class="trait-name">' + item.name + (item.cost ? ' (Cost: ' + item.cost + ' RP)' : '') + '</div>' +
                        (item.category ? '<div class="trait-description">Category: ' + item.category + '</div>' : '') + // Always show category for clarity
                        '<div class="trait-description">' + description + '</div>' +
                    '</div>' +
                    '<button class="btn btn-danger btn-small delete-' + type + '-btn" data-index="' + i + '" ' + disabledAttribute + '>Remove</button>' +
                '</div>';
            });
            return html;
        }

        // Removed addBattleTrait as dropdown is removed
function addBattleTrait(category, traitName) {
    try {
        const currentUnit = getCurrentUnit();
        if (!currentUnit || currentUnit.status === 'destroyed') {
            showNotification('Please select an active unit first to add traits.', 'warning');
            return;
        }

        const trait = crusadeTraits[category]?.[traitName];
        if (!trait) {
            showNotification('Invalid trait selected.', 'error');
            return;
        }

        if (!currentUnit.battleTraits) currentUnit.battleTraits = [];

        const existingTrait = currentUnit.battleTraits.find(t => t.name === traitName && t.category === category);
        if (existingTrait) {
            showNotification('Unit already has this trait.', 'warning');
            return;
        }

        if (trait.cost > 0 && !deductArmyRP(trait.cost, `Purchase trait "${traitName}" for unit "${currentUnit.name}"`, currentUnit.id)) {
            return;
        }

        currentUnit.battleTraits.push({ 
            category: category, 
            name: traitName, 
            cost: trait.cost, 
            description: trait.description 
        });
        
        renderUnitTraits();
        autoSave();
        showNotification('Added battle trait: ' + traitName, 'success');
    } catch (error) {
        console.error("Error in addBattleTrait:", error);
        showNotification('Error adding battle trait.', 'error');
    }
}

        function addManualBattleTrait() {
            try {
                const currentUnit = getCurrentUnit();
                if (!currentUnit || currentUnit.status === 'destroyed') {
                    showNotification('Please select an active unit first to add traits.', 'warning');
                    return;
                }

                const manualTraitCategoryInput = document.getElementById('manual-trait-category-input');
                const manualTraitNameInput = document.getElementById('manual-trait-name-input');
                const manualTraitCostInput = document.getElementById('manual-trait-cost-input');

                const category = manualTraitCategoryInput.value.trim();
                const traitName = manualTraitNameInput.value.trim();
                const cost = parseInt(manualTraitCostInput.value) || 0;

                if (!category || !traitName) {
                    showNotification('Trait Category and Name are required.', 'warning');
                    return;
                }

                if (!currentUnit.battleTraits) currentUnit.battleTraits = [];

                const existingTrait = currentUnit.battleTraits.find(function(t) { return t.name === traitName && t.category === category; });
                if (existingTrait) {
                    showNotification('Unit already has this trait.', 'warning');
                    return;
                }

                if (cost > 0 && !deductArmyRP(cost, `Purchase trait "${traitName}" for unit "${currentUnit.name}"`, currentUnit.id)) {
                    return; // Stop if RP deduction failed
                }

                currentUnit.battleTraits.push({ category: category, name: traitName, cost: cost, description: `Manually added trait: ${traitName}` });
                renderUnitTraits();
                autoSave();
                showNotification('Added battle trait: ' + traitName, 'success');
                manualTraitCategoryInput.value = '';
                manualTraitNameInput.value = '';
                manualTraitCostInput.value = '0';
            } catch (error) {
                console.error("Error in addManualBattleTrait:", error);
                showNotification('Error adding battle trait.', 'error');
            }
        }


        function addBattleScar(category, scarName, unitId = null) {
            try {
                const targetUnit = unitId ? crusadeData.units.find(u => u.id === unitId) : getCurrentUnit();
                if (!targetUnit || targetUnit.status === 'destroyed') {
                    showNotification('Please select an active unit first to add scars.', 'warning');
                    return false;
                }

                let actualCategory = category;
                let actualScarName = scarName;
                let description = '';

                // If called from the UI (without category and scarName arguments), get values from manual inputs
                if (arguments.length === 0 || category === null || scarName === null) {
                    const manualScarCategoryInput = document.getElementById('manual-scar-category-input');
                    const manualScarNameInput = document.getElementById('manual-scar-name-input');
                    actualCategory = manualScarCategoryInput.value.trim();
                    actualScarName = manualScarNameInput.value.trim();

                    if (!actualCategory || !actualScarName) {
                        showNotification('Scar Category and Name are required.', 'warning');
                        return false;
                    }
                    description = `Manually added scar: ${actualScarName}`;
                } else {
                    // If called programmatically (e.g., from Out of Action, Combat Revival)
                    const scar = battleScars[actualCategory]?.[actualScarName];
                    description = scar ? scar.description : `Manually added scar: ${actualScarName}`;
                }
                
                if (!targetUnit.battleScars) targetUnit.battleScars = [];
                
                // Check for duplicate scars, especially for manual entries where category + name combination matters
                const existingScar = targetUnit.battleScars.find(s => s.name === actualScarName && s.category === actualCategory);
                if (existingScar) {
                    showNotification(`Unit already has this scar: ${actualScarName} (${actualCategory}).`, 'warning');
                    return false;
                }

                targetUnit.battleScars.push({ category: actualCategory, name: actualScarName, description: description });
                
                // Only re-render if it's a UI-triggered addition
                if (arguments.length === 0 || category === null) {
                    renderUnitTraits();
                    document.getElementById('manual-scar-category-input').value = '';
                    document.getElementById('manual-scar-name-input').value = '';
                } else {
                    // Re-render for dropdown selections too
                    renderUnitTraits();
                }
                autoSave();
                showNotification(`Added battle scar: ${actualScarName} to ${targetUnit.name}`, 'success');
                return true;
            } catch (error) {
                console.error("Error in addBattleScar:", error);
                showNotification('Error adding battle scar.', 'error');
                return false;
            }
        }

        // Renamed addManualBattleScar to addBattleScar and adjusted its logic
        function addManualBattleScar() {
            // This function now simply calls the unified addBattleScar without arguments
            // to pull values from the manual input fields.
            addBattleScar(null, null);
        }


        function removeTrait(type, index) {
            try {
                const currentUnit = getCurrentUnit();
                if (!currentUnit || currentUnit.status === 'destroyed') {
                    showNotification('Cannot remove traits/scars from a destroyed unit. Revive it first.', 'warning');
                    return;
                }
                
                if (type === 'trait') {
                    const removedTrait = currentUnit.battleTraits[index];
                    currentUnit.battleTraits.splice(index, 1);
                    if (removedTrait.cost) { // Only refund if a cost was associated
                        addArmyRP(removedTrait.cost, `Refund for removing trait "${removedTrait.name}" from ${currentUnit.name}`, currentUnit.id);
                    }
                    showNotification('Removed trait ' + removedTrait.name + '.', 'success');
                } else {
                    const removedScar = currentUnit.battleScars[index];
                    currentUnit.battleScars.splice(index, 1);
                    showNotification('Removed scar ' + removedScar.name + '.', 'success');
                }
                
                renderUnitTraits();
                autoSave();
            } catch (error) {
                console.error("Error in removeTrait:", error);
                showNotification('Error removing trait/scar.', 'error');
            }
        }

        function renderRequisitionTracker() {
            try {
                const container = document.getElementById('requisition-content');
                if (!container) {
                    console.warn("Element 'requisition-content' not found for rendering.");
                    return;
                }
                
                container.innerHTML = 
                    '<div class="card rp-tracker">' +
                        '<div class="rp-header">' +
                            '<div class="rp-title">üéñÔ∏è Army Requisition Points</div>' +
                            '<div class="rp-points">' + crusadeData.requisitionPoints + ' RP</div>' +
                        '</div>' +
                        '<div style="color: #ccc; font-size: 0.9rem;">Total Army RP: ' + crusadeData.requisitionPoints + '</div>' +
                        '<div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem;">' +
                            '<button class="btn btn-success btn-small" id="add-rp-1-btn">+1 RP</button>' +
                            '<button class="btn btn-success btn-small" id="add-rp-5-btn">+5 RP</button>' +
                            '<button class="btn btn-danger btn-small" id="deduct-rp-1-btn">-1 RP</button>' +
                            '<button class="btn btn-danger btn-small" id="deduct-rp-5-btn">-5 RP</button>' +
                        '</div>' +
                    '</div>' +
                    '<div class="card">' +
                        '<h2>üí∞ Requisition Actions</h2>' +
                        // New: Manual Requisition Entry Section
                        '<div class="manual-entry-section">' +
                            '<h4>Manual Requisition Entry</h4>' +
                            '<div class="form-grid">' +
                                '<div class="form-group">' +
                                    '<label for="manual-req-name-input">Action Name</label>' +
                                    '<input type="text" id="manual-req-name-input" placeholder="e.g., Acquire Relic" >' +
                                '</div>' +
                                '<div class="form-group">' +
                                    '<label for="manual-req-cost-input">Cost (RP)</label>' +
                                    '<input type="number" id="manual-req-cost-input" value="0" min="0" placeholder="0">' +
                                '</div>' +
                                '<div class="form-group" style="grid-column: 1 / -1;">' +
                                    '<label for="manual-req-desc-input">Description</label>' +
                                    '<textarea id="manual-req-desc-input" rows="2" placeholder="Describe the action..."></textarea>' +
                                '</div>' +
                                '<div class="form-group" style="grid-column: 1 / -1; display: flex; align-items: flex-end;">' +
                                    '<button class="btn btn-primary btn-small" id="add-manual-requisition-btn">Apply Manual Requisition</button>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        // End New: Manual Requisition Entry Section
                        '<div class="rp-actions" id="requisition-actions-grid">' +
                            renderRequisitionActions() +
                        '</div>' +
                    '</div>' +
                    '<div class="card">' +
                        '<h2>üìñ Requisition Rules</h2>' +
                        '<div style="background: #1a1a2e; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">' +
                            '<h4 style="color: #ffd700; margin-bottom: 0.5rem;">Earning Requisition Points</h4>' +
                            '<ul style="color: #ccc; font-size: 0.9rem; margin-left: 1rem;">' +
                                '<li>Army gains RP from completing agendas and missions.</li>' +
                                '<li>Some traits require spending RP to purchase.</li>' +
                            '</ul>' +
                        '</div>' +
                        '<div style="background: #1a1a2e; padding: 1rem; border-radius: 8px;">' +
                            '<h4 style="color: #ffd700; margin-bottom: 0.5rem;">Using Requisition Points</h4>' +
                            '<ul style="color: #ccc; font-size: 0.9rem; margin-left: 1rem;">' +
                                '<li>Purchase Battle Traits for units.</li>' +
                                '<li>Remove Battle Scars.</li>' +
                                '<li>Add new units to your Order of Battle.</li>' +
                                '<li>Upgrade equipment and weapons.</li>' +
                            '</ul>' +
                        '</div>' +
                    '</div>';

                document.getElementById('add-rp-1-btn').addEventListener('click', function() { addArmyRP(1, 'Manual adjustment'); });
                document.getElementById('add-rp-5-btn').addEventListener('click', function() { addArmyRP(5, 'Manual adjustment'); });
                document.getElementById('deduct-rp-1-btn').addEventListener('click', function() { deductArmyRP(1, 'Manual adjustment'); });
                document.getElementById('deduct-rp-5-btn').addEventListener('click', function() { deductArmyRP(5, 'Manual adjustment'); });

                // Event listener for the new manual requisition button
                document.getElementById('add-manual-requisition-btn').addEventListener('click', applyManualRequisition);


                document.querySelectorAll('#requisition-actions-grid .rp-action').forEach(actionDiv => {
                    const actionName = actionDiv.dataset.actionName;
                    if (actionName) {
                        actionDiv.addEventListener('click', function() { useRequisitionAction(actionName); });
                    }
                });

            } catch (error) {
                console.error("Error in renderRequisitionTracker:", error);
                showNotification('Error rendering requisition tracker.', 'error');
            }
        }

        function renderRequisitionActions() {
            let html = '';
            Object.keys(requisitionActions).forEach(function(actionName) {
                const action = requisitionActions[actionName];
                html += '<div class="rp-action" data-action-name="' + actionName + '">' +
                    '<div class="rp-action-name">' + actionName + '</div>' +
                    '<div class="rp-action-cost">' + action.cost + ' RP</div>' +
                    '<div class="rp-action-desc">' + action.description + '</div>' +
                '</div>';
            });
            return html;
        }

        function addArmyRP(amount, description = 'manual adjustment', unitId = null) {
            try {
                crusadeData.requisitionPoints = Math.max(0, crusadeData.requisitionPoints + amount);
                const newBalance = crusadeData.requisitionPoints;

                crusadeData.rpLedger.push({
                    id: generateLedgerId(),
                    date: new Date().toISOString().slice(0, 10),
                    type: 'gain',
                    amount: amount,
                    description: description,
                    unitId: unitId,
                    balanceAfter: newBalance
                });

                renderRequisitionTracker();
                renderRPLedger();
                updateArmyStats();
                autoSave();
                showNotification(`Added ${amount} Requisition Points (${description}).`, 'info');
            } catch (error) {
                console.error("Error in addArmyRP:", error);
            }
        }

        function deductArmyRP(amount, description = 'manual adjustment', unitId = null) {
            try {
                // Handle cases where cost might be a range (e.g., '1-3')
                let actualAmount = amount;
                if (typeof amount === 'string' && amount.includes('-')) {
                    const range = amount.split('-').map(Number);
                    // For deduction, we can assume the user means the lowest possible cost unless specified otherwise
                    // Or, for a general prompt, ask the user to input the specific amount.
                    // For now, let's just make sure it's a number. If it's a range, assume the lower bound.
                    actualAmount = range[0]; 
                    showNotification(`Requisition cost is a range (${amount}). Proceeding with lowest cost: ${actualAmount} RP.`, 'info');
                }

                if (crusadeData.requisitionPoints >= actualAmount) {
                    crusadeData.requisitionPoints -= actualAmount;
                    const newBalance = crusadeData.requisitionPoints;

                    crusadeData.rpLedger.push({
                        id: generateLedgerId(),
                        date: new Date().toISOString().slice(0, 10),
                        type: 'spend',
                        amount: actualAmount,
                        description: description,
                        unitId: unitId,
                        balanceAfter: newBalance
                    });

                    renderRequisitionTracker();
                    renderRPLedger();
                    updateArmyStats();
                    autoSave();
                    showNotification(`Spent ${actualAmount} Requisition Points for ${description}.`, 'info');
                    return true;
                } else {
                    showNotification('Not enough Requisition Points! Need ' + actualAmount + ' RP.', 'warning');
                    return false;
                }
            } catch (error) {
                console.error("Error in deductArmyRP:", error);
                showNotification('Error deducting RP.', 'error');
                return false;
            }
        }

        function useRequisitionAction(actionName) {
            try {
                const action = requisitionActions[actionName];
                if (!action) return;
                
                // For actions with variable costs, prompt the user for the exact cost
                let costToDeduct = action.cost;
                if (typeof action.cost === 'string' && action.cost.includes('-')) {
                    const userInput = prompt(`Enter the exact RP cost for "${actionName}" (${action.cost} RP):`);
                    if (userInput === null || isNaN(parseInt(userInput))) {
                        showNotification('Invalid or cancelled cost input. Requisition not applied.', 'warning');
                        return;
                    }
                    costToDeduct = parseInt(userInput);
                }

                if (confirm('Use "' + actionName + '" for ' + costToDeduct + ' RP?\n\n' + action.description)) {
                    if (deductArmyRP(costToDeduct, `Requisition Action: ${actionName}`)) {
                        if (actionName === 'Fresh Recruits') {
                             createNewUnit(); // Placeholder for now, ideally prompt for PL and deduct accordingly
                        } else if (actionName === 'Rearm and Resupply') {
                            showNotification('Select a unit and a scar to remove in the Traits tab.', 'info');
                            switchTab('traits');
                        } else if (actionName === 'Increase Supply Limit') {
                            // Update supply limit based on the currently selected tracking mode
                            if (crusadeData.trackByPoints) {
                                crusadeData.supplyLimitPoints += 200; // Increase by 200 points
                                showNotification('Supply Limit increased by 200 Points!', 'success');
                            } else {
                                // Assuming 1 PL = 20 points, so 200 points = 10 PL
                                crusadeData.supplyLimitPoints += 10; // Increase by 10 PL
                                showNotification('Supply Limit increased by 10 Power Level!', 'success');
                            }
                            updateArmyStats();
                        } else if (actionName === 'Renowned Heroes') {
                            showNotification('Select a unit to promote or add a Heroic trait. (Manual adjustment in unit progress/traits for now)', 'info');
                            switchTab('progress'); // Guide user to relevant tab
                        } else if (actionName === 'Legendary Veterans') {
                            showNotification('Select a unit to promote or add a Legendary trait. (Manual adjustment in unit progress/traits for now)', 'info');
                            switchTab('progress'); // Guide user to relevant tab
                        } else if (actionName === 'Repair and Recuperate') {
                            showNotification('Select a unit to remove a scar or restore models/wounds. (Manual adjustment in unit progress/traits for now)', 'info');
                            switchTab('progress'); // Guide user to relevant tab
                        } else if (actionName === 'Combat Revival') {
                            showReviveUnitModal();
                        } else if (actionName === 'Manual Requisition') {
                            // This action will be handled by a dedicated input form, not directly via this button.
                            // The renderRequisitionTracker function sets up the separate UI for it.
                            showNotification('Please use the "Manual Requisition Entry" section below to enter custom actions.', 'info');
                        }
                    }
                }
            } catch (error) {
                console.error("Error in useRequisitionAction:", error);
                showNotification('Error using requisition action.', 'error');
            }
        }

        function applyManualRequisition() {
            try {
                const nameInput = document.getElementById('manual-req-name-input');
                const costInput = document.getElementById('manual-req-cost-input');
                const descInput = document.getElementById('manual-req-desc-input');

                const name = nameInput.value.trim();
                const cost = parseInt(costInput.value) || 0;
                const description = descInput.value.trim();

                if (!name || cost < 0) {
                    showNotification('Manual Requisition Name is required and Cost must be a non-negative number.', 'warning');
                    return;
                }

                if (deductArmyRP(cost, `Manual Requisition: ${name}` + (description ? ` (${description})` : ''))) {
                    showNotification(`Applied manual requisition: "${name}" for ${cost} RP.`, 'success');
                    nameInput.value = '';
                    costInput.value = '0';
                    descInput.value = '';
                }
            } catch (error) {
                console.error("Error applying manual requisition:", error);
                showNotification('Error applying manual requisition.', 'error');
            }
        }


        // Updated function to handle supply limit adjustment based on crusade level and tracking mode
        function updateArmyStats() {
            try {
                const activeUnits = crusadeData.units.filter(unit => unit.status === 'active');
                const totalUnits = activeUnits.length;
                let totalPoints = 0;
                let totalPL = 0;
                let totalXP = 0;
                let totalBattles = crusadeData.crusadeLog.length;

                activeUnits.forEach(function(unit) {
                    totalPoints += unit.pointsCost || 0;
                    totalPL += unit.powerLevel || 0;
                    totalXP += unit.xp || 0;
                });

                // Update crusadeData.supplyLimitPoints based on selected crusadeLevel
                let baseSupplyLimit = 0;
                if (crusadeData.crusadeLevel in CRUSADE_LEVELS) {
                    baseSupplyLimit = CRUSADE_LEVELS[crusadeData.crusadeLevel];
                }

                // If tracking by points, convert the base PL limit to points
                if (crusadeData.trackByPoints) {
                    crusadeData.supplyLimitPoints = convertPLToPoints(baseSupplyLimit);
                } else {
                    crusadeData.supplyLimitPoints = baseSupplyLimit;
                }
                
                const currentSupplyLimit = crusadeData.supplyLimitPoints;
                let remainingSupply;
                let supplyLimitType;
                let remainingSupplyType;

                if (crusadeData.trackByPoints) {
                    remainingSupply = currentSupplyLimit - totalPoints;
                    supplyLimitType = 'Points';
                    remainingSupplyType = 'Points';
                } else {
                    remainingSupply = currentSupplyLimit - totalPL;
                    supplyLimitType = 'PL';
                    remainingSupplyType = 'PL';
                }

                document.getElementById('total-units').textContent = totalUnits;
                document.getElementById('total-points').textContent = totalPoints;
                document.getElementById('total-pl').textContent = totalPL;
                document.getElementById('current-supply-limit').textContent = currentSupplyLimit;
                document.getElementById('supply-limit-type').textContent = supplyLimitType;
                document.getElementById('remaining-supply-limit').textContent = remainingSupply;
                document.getElementById('remaining-supply-type').textContent = remainingSupplyType;
                document.getElementById('total-xp').textContent = totalXP;
                document.getElementById('total-battles').textContent = totalBattles;

                const armyNameInput = document.getElementById('army-name-input');
                if (armyNameInput) armyNameInput.value = crusadeData.armyName;
                const crusadeLevelSelect = document.getElementById('crusade-level-select');
                if (crusadeLevelSelect) crusadeLevelSelect.value = crusadeData.crusadeLevel;
                const armyRpInput = document.getElementById('army-rp-input');
                if (armyRpInput) armyRpInput.value = crusadeData.requisitionPoints;

                const ledgerCurrentRpDisplay = document.getElementById('ledger-current-rp');
                if (ledgerCurrentRpDisplay) {
                    ledgerCurrentRpDisplay.textContent = crusadeData.requisitionPoints;
                }
                
                // Update toggle state
                const trackingModeToggle = document.getElementById('tracking-mode-toggle');
                if (trackingModeToggle) {
                    trackingModeToggle.checked = !crusadeData.trackByPoints; // Checked means PL, Unchecked means Points
                }

                renderUnitDetails(); // Re-render unit details to reflect cost input changes
                renderUnitsGrid(); // Re-render unit grid to reflect CP/PL display change

            } catch (error) {
                console.error("Error in updateArmyStats:", error);
            }
        }

        function updateArmySettings(field, value) {
            try {
                if (field === 'requisitionPoints') {
                    const oldValue = crusadeData[field];
                    const newValue = parseInt(value) || 0;
                    crusadeData[field] = newValue;

                    if (newValue !== oldValue) {
                        const difference = newValue - oldValue;
                        const type = difference > 0 ? 'gain' : 'spend';
                        if (type === 'gain') {
                            addArmyRP(Math.abs(difference), `Manual RP adjustment`);
                        } else {
                            deductArmyRP(Math.abs(difference), `Manual RP adjustment`);
                        }
                    }
                } else if (field === 'crusadeLevel') {
                    crusadeData.crusadeLevel = value;
                    // SupplyLimitPoints will be updated automatically by updateArmyStats due to crusadeLevel change
                }
                else {
                    crusadeData[field] = value;
                }
                updateArmyStats();
                autoSave();
            } catch (error) {
                console.error("Error in updateArmySettings:", error);
                showNotification('Error updating army settings.', 'error');
            }
        }

        function toggleTrackingMode() {
            crusadeData.trackByPoints = !document.getElementById('tracking-mode-toggle').checked;
            updateArmyStats();
            autoSave();
            showNotification(`Tracking mode switched to ${crusadeData.trackByPoints ? 'Points' : 'Power Level'}.`, 'info');
       const trackingModeText = document.getElementById('tracking-mode-text');
if (trackingModeText) {
    if (crusadeData.trackByPoints) {
        trackingModeText.textContent = 'Points';
        trackingModeText.style.color = '#3b82f6'; // Blue for Points
    } else {
        trackingModeText.textContent = 'Power Level';
        trackingModeText.style.color = '#ffd700'; // Yellow for PL
    }
}
	}

        function switchTab(tabName) {
            try {
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                document.querySelectorAll('.tab').forEach(tabBtn => {
                    tabBtn.classList.remove('active');
                });
                
                const targetContent = document.getElementById(tabName + '-tab-content');
                if (targetContent) {
                    targetContent.classList.add('active');
                } else {
                    console.warn(`Content for tab "${tabName}" not found.`);
                }
                
                const targetTabBtn = document.getElementById(tabName + '-tab-btn');
                if (targetTabBtn) {
                    targetTabBtn.classList.add('active');
                } else {
                    console.warn(`Button for tab "${tabName}" not found.`);
                }

                if (tabName === 'details') renderUnitDetails();
                else if (tabName === 'weapons') renderUnitWeapons();
                else if (tabName === 'progress') renderUnitProgress();
                else if (tabName === 'traits') renderUnitTraits();
                else if (tabName === 'agendas') renderAgendasTab();
                else if (tabName === 'requisition') renderRequisitionTracker();
                else if (tabName === 'rp-ledger') renderRPLedger();
                else if (tabName === 'army') updateArmyStats();
                else if (tabName === 'crusade-log') {
                    renderCrusadeLog();
                    renderAgendaTrackingForBattle();
                }
            } catch (error) {
                console.error("Error in switchTab:", error);
                showNotification('Error switching tab.', 'error');
            }
        }

        function clearUnitViews() {
            try {
                document.getElementById('unit-details-content').innerHTML = '<div class="no-unit-selected"><h3>No Unit Selected</h3><p>Select a unit from the Units tab to view and edit its details.</p></div>';
                document.getElementById('weapons-content').innerHTML = '<div class="no-unit-selected"><h3>No Unit Selected</h3><p>Select a unit from the Units tab to manage its weapons.</p></div>';
                document.getElementById('progress-content').innerHTML = '<div class="no-unit-selected"><h3>No Unit Selected</h3><p>Select a unit from the Units tab to track its crusade progress.</p></div>';
                document.getElementById('traits-content').innerHTML = '<div class="no-unit-selected"><h3>No Unit Selected</h3><p>Select a unit from the Units tab to manage its traits and scars.</p></div>';
                renderRequisitionTracker();
            } catch (error) {
                console.error("Error in clearUnitViews:", error);
            }
        }

        // --- Agenda Management Functions ---

        function renderAgendasTab() {
            const container = document.getElementById('agendas-tab-content');
            if (!container) return;

            renderAgendaList();
            renderAgendaAssignment();
        }

        function renderAgendaList() {
            const listContainer = document.getElementById('agenda-list');
            if (!listContainer) return;

            if (crusadeData.crusadeAgendas.length === 0) {
                listContainer.innerHTML = '<div class="empty-state">No agendas defined yet. Create one above!</div>';
                return;
            }

            let html = '';
            crusadeData.crusadeAgendas.forEach((agenda, index) => {
                html += `
                    <div class="agenda-item">
                        <div class="agenda-details">
                            <div class="agenda-name">${agenda.name}</div>
                            <div class="agenda-reward">Reward: ${agenda.xp} XP</div>
                            <div class="agenda-description">${agenda.description}</div>
                        </div>
                        <button class="btn btn-danger btn-small delete-agenda-btn" data-index="${index}">üóëÔ∏è</button>
                    </div>
                `;
            });
            listContainer.innerHTML = html;

            document.querySelectorAll('.delete-agenda-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    deleteAgenda(parseInt(this.dataset.index));
                });
            });
        }

        function addNewAgenda() {
            const nameInput = document.getElementById('new-agenda-name');
            const xpInput = document.getElementById('new-agenda-xp');
            const descInput = document.getElementById('new-agenda-desc');

            const name = nameInput.value.trim();
            const xp = parseInt(xpInput.value) || 0;
            const description = descInput.value.trim();

            if (!name || !description) {
                showNotification('Agenda Name and Description are required.', 'warning');
                return;
            }

            if (crusadeData.crusadeAgendas.some(a => a.name.toLowerCase() === name.toLowerCase())) {
                showNotification(`An agenda named "${name}" already exists.`, 'warning');
                return;
            }

            crusadeData.crusadeAgendas.push({ name, xp, description });
            
            nameInput.value = '';
            xpInput.value = '1';
            descInput.value = '';

            renderAgendaList();
            renderAgendaAssignment();
            autoSave();
            showNotification('Agenda added successfully.', 'success');
        }

        function deleteAgenda(index) {
            if (!confirm('Are you sure you want to delete this agenda? It will be unassigned from all units.')) {
                return;
            }
            const deletedAgenda = crusadeData.crusadeAgendas.splice(index, 1)[0];

            crusadeData.units.forEach(unit => {
                if (unit.agendas) {
                    unit.agendas = unit.agendas.filter(agendaName => agendaName !== deletedAgenda.name);
                }
            });

            renderAgendaList();
            renderAgendaAssignment();
            autoSave();
            showNotification('Agenda deleted.', 'success');
        }

        function renderAgendaAssignment() {
            const assignmentContainer = document.getElementById('agenda-assignment-list');
            if (!assignmentContainer) return;

            const activeUnits = crusadeData.units.filter(u => u.status === 'active');

            if (activeUnits.length === 0) {
                assignmentContainer.innerHTML = '<div class="empty-state">No active units to assign agendas to.</div>';
                return;
            }

            let agendaOptionsHtml = '<option value="">-- No Agenda --</option>';
            crusadeData.crusadeAgendas.forEach(agenda => {
                agendaOptionsHtml += `<option value="${agenda.name}">${agenda.name}</option>`;
            });

            let html = '';
            activeUnits.forEach(unit => {
                const assignedAgenda = unit.agendas ? unit.agendas[0] || '' : '';

                html += `
                    <div class="agenda-assignment-row">
                        <div class="agenda-assignment-unit-name">${unit.name}</div>
                        <div class="agenda-assignment-select">
                            <select class="unit-agenda-select" data-unit-id="${unit.id}">
                                ${agendaOptionsHtml}
                            </select>
                        </div>
                    </div>
                `;
            });
            assignmentContainer.innerHTML = html;
            
            document.querySelectorAll('.unit-agenda-select').forEach(select => {
                const unitId = parseInt(select.dataset.unitId);
                const unit = crusadeData.units.find(u => u.id === unitId);
                if (unit && unit.agendas && unit.agendas.length > 0) {
                    select.value = unit.agendas[0];
                }

                select.addEventListener('change', function() {
                    assignAgendaToUnit(unitId, this.value);
                });
            });
        }

        function assignAgendaToUnit(unitId, agendaName) {
            const unit = crusadeData.units.find(u => u.id === unitId);
            if (!unit) return;

            if (!unit.agendas) unit.agendas = [];

            unit.agendas = []; 
            if (agendaName) {
                unit.agendas.push(agendaName);
                showNotification(`Assigned "${agendaName}" to ${unit.name}.`, 'success');
            } else {
                showNotification(`Removed agenda from ${unit.name}.`, 'info');
            }

            autoSave();
        }

        // --- Battle Log & Agenda Tracking at Battle Time ---

        function renderAgendaTrackingForBattle() {
            const container = document.getElementById('battle-agenda-tracker');
            if (!container) return;

            const unitsWithAgendas = crusadeData.units.filter(u => u.status === 'active' && u.agendas && u.agendas.length > 0);

            if (unitsWithAgendas.length === 0) {
                container.innerHTML = '<div class="empty-state">No active units have agendas assigned. Visit the Agendas tab to assign them.</div>';
                return;
            }

            let html = '';
            unitsWithAgendas.forEach(unit => {
                unit.agendas.forEach(agendaName => {
                    const agendaData = crusadeData.crusadeAgendas.find(a => a.name === agendaName);
                    if (agendaData) {
                        html += `
                            <div class="trait-item" style="flex-direction: column; align-items: flex-start; gap: 0.5rem; border-left: 4px solid #3b82f6;">
                                <div style="width: 100%; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="color: #ccc; font-weight: bold;">${unit.name}</div>
                                        <div class="agenda-name">${agendaName} (+${agendaData.xp} XP)</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="agenda-check-${unit.id}-${agendaName.replace(/\s/g, '')}" style="cursor: pointer;">Completed?</label>
                                        <input type="checkbox" id="agenda-check-${unit.id}-${agendaName.replace(/\s/g, '')}" class="battle-agenda-checkbox" data-unit-id="${unit.id}" data-agenda-name="${agendaName}" style="width: 20px; height: 20px;">
                                    </div>
                                </div>
                                <div class="trait-description">${agendaData.description}</div>
                            </div>
                        `;
                    }
                });
            });
            container.innerHTML = html;
        }

        function recordBattle() {
            try {
                const date = document.getElementById('log-date').value;
                const opponent = document.getElementById('log-opponent').value;
                const mission = document.getElementById('log-mission').value;
                const outcome = document.getElementById('log-outcome').value;
                const xpGained = parseInt(document.getElementById('log-xp-gained').value) || 0;
                const rpGained = parseInt(document.getElementById('log-rp-gained').value) || 0;
                const notes = document.getElementById('log-notes').value;
                
                const completedAgendas = [];
                let totalAgendaXP = 0;
                document.querySelectorAll('.battle-agenda-checkbox:checked').forEach(checkbox => {
                    const unitId = parseInt(checkbox.dataset.unitId);
                    const agendaName = checkbox.dataset.agendaName;
                    const unit = crusadeData.units.find(u => u.id === unitId);
                    const agendaData = crusadeData.crusadeAgendas.find(a => a.name === agendaName);

                    if (unit && agendaData) {
                        const xpAwarded = agendaData.xp || 0;
                        completedAgendas.push({
                            unitId: unitId,
                            unitName: unit.name,
                            agendaName: agendaName,
                            xpAwarded: xpAwarded
                        });
                        totalAgendaXP += xpAwarded;
                        applyXPToUnit(unitId, xpAwarded);
                    }
                });

                if (!date || !opponent || !mission || !outcome) {
                    showNotification('Please fill in Date, Opponent, Mission, and Outcome to record a battle.', 'warning');
                    return;
                }

                const newBattle = {
                    id: crusadeData.crusadeLog.length > 0 ? Math.max(...crusadeData.crusadeLog.map(b => b.id)) + 1 : 1,
                    date: date,
                    opponent: opponent,
                    mission: mission,
                    outcome: outcome,
                    xpGained: xpGained,
                    rpGained: rpGained,
                    agendasCompleted: completedAgendas,
                    notes: notes,
                    recordedAt: new Date().toISOString()
                };

                crusadeData.crusadeLog.push(newBattle);
                addArmyRP(rpGained, `Battle gain from "${mission}" vs ${opponent}`);
                
                renderCrusadeLog();
                updateArmyStats();
                autoSave();
                showNotification(`Battle recorded! ${totalAgendaXP} XP from agendas was automatically applied.`, 'success');

                document.getElementById('log-date').value = new Date().toISOString().slice(0, 10);
                document.getElementById('log-opponent').value = '';
                document.getElementById('log-mission').value = '';
                document.getElementById('log-outcome').value = '';
                document.getElementById('log-xp-gained').value = '0';
                document.getElementById('log-rp-gained').value = '0';
                document.getElementById('log-notes').value = '';
                renderAgendaTrackingForBattle();

                if (xpGained > 0 && crusadeData.units.filter(u => u.status === 'active').length > 0) {
                    showXPDistributionModal(xpGained);
                } else if (xpGained > 0) {
                    showNotification('No active units available to distribute base XP.', 'info');
                }

            } catch (error) {
                console.error("Error recording battle:", error);
                showNotification('Error recording battle.', 'error');
            }
        }

        function editBattle(battleId) {
            showNotification('Editing past battles is currently not supported with the new agenda system.', 'info');
        }

        function deleteBattle(battleId) {
            if (!confirm('Are you sure you want to delete this battle entry? This will NOT automatically remove the XP units gained from it.')) {
                return;
            }
            const battleToDelete = crusadeData.crusadeLog.find(b => b.id === battleId);
            if (battleToDelete) {
                if (battleToDelete.rpGained > 0) {
                    deductArmyRP(battleToDelete.rpGained, `RP removed due to deleted battle: "${battleToDelete.mission}" vs ${battleToDelete.opponent}`);
                }
            }

            crusadeData.crusadeLog = crusadeData.crusadeLog.filter(b => b.id !== battleId);
            renderCrusadeLog();
            updateArmyStats();
            autoSave();
            showNotification('Battle entry deleted.', 'success');
        }

        function renderCrusadeLog() {
            try {
                const logList = document.getElementById('battle-log-list');
                if (!logList) return;

                if (crusadeData.crusadeLog.length === 0) {
                    logList.innerHTML = '<div class="empty-state">No battles recorded yet.</div>';
                    return;
                }

                let html = '';
                crusadeData.crusadeLog.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(battle => {
                    const outcomeClass = battle.outcome === 'Win' ? 'outcome-win' : (battle.outcome === 'Loss' ? 'outcome-loss' : 'outcome-draw');
                    let agendaHtml = '';
                    if(battle.agendasCompleted && battle.agendasCompleted.length > 0) {
                        agendaHtml = `
                        <div class="agenda-completion-log">
                            <h4>Agenda Completions</h4>
                            ${battle.agendasCompleted.map(agenda => `
                                <div class="agenda-completion-item">
                                    <strong>${agenda.unitName}</strong> completed <strong>${agenda.agendaName}</strong> (+${agenda.xpAwarded} XP)
                                </div>
                            `).join('')}
                        </div>
                        `;
                    }
                    
                    html += `
                        <div class="battle-log-entry">
                            <div class="edit-delete-buttons">
                                <button class="btn btn-info btn-small edit-battle-btn" data-battle-id="${battle.id}" disabled title="Editing disabled for now">‚úèÔ∏è</button>
                                <button class="btn btn-danger btn-small delete-battle-btn" data-battle-id="${battle.id}">üóëÔ∏è</button>
                            </div>
                            <div class="battle-header">
                                <h3>Battle on ${battle.date} vs ${battle.opponent}</h3>
                                <span class="battle-outcome ${outcomeClass}">${battle.outcome}</span>
                            </div>
                            <div class="battle-meta">
                                Mission: ${battle.mission} | Base XP: ${battle.xpGained} | RP Gained: ${battle.rpGained}
                            </div>
                            ${agendaHtml}
                            ${battle.notes ? `<p style="font-size: 0.9em; color: #bbb; margin-top: 0.75rem;"><strong>Notes:</strong> ${battle.notes}</p>` : ''}
                        </div>
                    `;
                });
                logList.innerHTML = html;

                document.querySelectorAll('.edit-battle-btn').forEach(button => {
                    button.addEventListener('click', function() { editBattle(parseInt(this.dataset.battleId)); });
                });
                document.querySelectorAll('.delete-battle-btn').forEach(button => {
                    button.addEventListener('click', function() { deleteBattle(parseInt(this.dataset.battleId)); });
                });

            } catch (error) {
                console.error("Error rendering crusade log:", error);
            }
        }

        // --- RP Ledger Display Functions ---
        function renderRPLedger() {
            const ledgerList = document.getElementById('rp-ledger-list');
            const ledgerCurrentRpDisplay = document.getElementById('ledger-current-rp');

            if (!ledgerList || !ledgerCurrentRpDisplay) {
                console.warn("RP Ledger elements not found.");
                return;
            }

            ledgerCurrentRpDisplay.textContent = crusadeData.requisitionPoints;

            if (crusadeData.rpLedger.length === 0) {
                ledgerList.innerHTML = '<div class="empty-state">No RP transactions recorded yet.</div>';
                return;
            }

            let html = `
                <table class="rp-ledger-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            crusadeData.rpLedger.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateA.getTime() === dateB.getTime()) {
                    return a.id - b.id;
                }
                return dateA - dateB;
            }).forEach(entry => {
                const amountClass = entry.type === 'gain' ? 'gain' : 'spend';
                const sign = entry.type === 'gain' ? '+' : '-';
                html += `
                    <tr>
                        <td>${entry.date}</td>
                        <td class="${amountClass}">${entry.type.charAt(0).toUpperCase() + entry.type.slice(1)}</td>
                        <td>${entry.description}</td>
                        <td class="${amountClass}">${sign}${entry.amount} RP</td>
                        <td class="balance">${entry.balanceAfter} RP</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;
            ledgerList.innerHTML = html;
        }

        // --- XP Distribution Modal Functions ---

        function showXPDistributionModal(totalXP) {
            const modal = document.getElementById('xp-distribution-modal');
            const modalTotalXP = document.getElementById('modal-total-xp');
            
            modalTotalXP.textContent = totalXP;
            modal.style.display = 'flex';

            renderXPDistributionInputs(totalXP);

            document.getElementById('distribute-xp-confirm-btn').onclick = function() { distributeXPToUnits(totalXP); };
            document.getElementById('distribute-xp-cancel-btn').onclick = hideXPDistributionModal;
        }

        function hideXPDistributionModal() {
            document.getElementById('xp-distribution-modal').style.display = 'none';
        }

        function renderXPDistributionInputs(totalXPToDistribute) {
            const unitsContainer = document.getElementById('modal-unit-xp-inputs');
            const xpRemainingDisplay = document.getElementById('modal-xp-remaining');
            unitsContainer.innerHTML = '';

            let xpInputs = [];

            crusadeData.units.filter(u => u.status === 'active').forEach(unit => {
                const unitRow = document.createElement('div');
                unitRow.className = 'modal-unit-row';
                unitRow.innerHTML = `
                    <div class="modal-unit-name">${unit.name || 'Unnamed Unit'}</div>
                    <div class="modal-unit-current-xp">(Current XP: ${unit.xp || 0})</div>
                    <input type="number" class="modal-xp-input" data-unit-id="${unit.id}" value="0" min="0">
                `;
                unitsContainer.appendChild(unitRow);
                xpInputs.push(unitRow.querySelector('.modal-xp-input'));
            });

            const updateXPRemaining = () => {
                let currentDistributedXP = 0;
                xpInputs.forEach(input => {
                    currentDistributedXP += parseInt(input.value) || 0;
                });
                xpRemainingDisplay.textContent = totalXPToDistribute - currentDistributedXP;

                const confirmBtn = document.getElementById('distribute-xp-confirm-btn');
                if (currentDistributedXP > totalXPToDistribute) {
                    confirmBtn.disabled = true;
                    xpRemainingDisplay.style.color = '#ef4444';
                } else {
                    confirmBtn.disabled = false;
                    xpRemainingDisplay.style.color = '#ffd700';
                }
            };

            xpInputs.forEach(input => {
                input.addEventListener('input', updateXPRemaining);
            });

            updateXPRemaining();
        }

        function distributeXPToUnits(totalXPFromBattle) {
            const xpInputs = document.querySelectorAll('#modal-unit-xp-inputs .modal-xp-input');
            let totalDistributed = 0;
            const distributionMap = {};

            xpInputs.forEach(input => {
                const unitId = parseInt(input.dataset.unitId);
                const xpAmount = parseInt(input.value) || 0;
                if (xpAmount < 0) {
                    showNotification('XP distributed cannot be negative.', 'error');
                    return;
                }
                totalDistributed += xpAmount;
                distributionMap[unitId] = xpAmount;
            });

            if (totalDistributed > totalXPFromBattle) {
                showNotification(`You are trying to distribute ${totalDistributed} XP, but only ${totalXPFromBattle} XP was gained from battle. Please adjust.`, 'warning');
                return;
            }
            
            crusadeData.units.forEach(unit => {
                const xpToApply = distributionMap[unit.id] || 0;
                if (xpToApply > 0) {
                    applyXPToUnit(unit.id, xpToApply);
                }
            });

            hideXPDistributionModal();
            showNotification('Base XP distributed successfully!', 'success');
            renderUnitsGrid();
            if (crusadeData.currentUnitId) {
                renderUnitProgress();
            }
            updateArmyStats();
            autoSave();
        }

        function applyXPToUnit(unitId, xpAmount) {
            const unit = crusadeData.units.find(u => u.id === unitId);
            if (!unit || unit.status === 'destroyed') return;

            const oldXP = unit.xp || 0;
            const oldRank = getCrusadeRank(oldXP);

            unit.xp = oldXP + xpAmount;
            unit.xp = Math.max(0, unit.xp);

            const newRank = getCrusadeRank(unit.xp);

            unit.crusadeRank = newRank.name;

            if (oldRank.name !== newRank.name) {
                let message = `${unit.name} has been promoted to ${newRank.name} (Total XP: ${unit.xp})!`;
                if (newRank.bonus && newRank.bonus !== 'None.') {
                    message += ` Bonus: ${newRank.bonus}`;
                }
                showNotification(message, 'info');
            }
            autoSave();
        }

        // --- Revive Unit Modal Functions ---

        function showReviveUnitModal() {
            const modal = document.getElementById('revive-unit-modal');
            const unitListDiv = document.getElementById('revive-unit-list');
            const reviveConfirmBtn = document.getElementById('revive-unit-confirm-btn');
            
            const destroyedUnits = crusadeData.units.filter(u => u.status === 'destroyed');

            if (destroyedUnits.length === 0) {
                unitListDiv.innerHTML = '<div class="empty-state" style="padding: 1rem; border: none; background: transparent;">No destroyed units to revive.</div>';
                reviveConfirmBtn.disabled = true;
            } else {
                let html = '';
                destroyedUnits.forEach(unit => {
                    html += `
                        <div class="modal-unit-row">
                            <input type="radio" name="unit-to-revive" id="revive-unit-${unit.id}" value="${unit.id}">
                            <label for="revive-unit-${unit.id}" class="modal-unit-name" style="flex-grow: 1; cursor: pointer; padding-left: 0.5rem;">${unit.name || 'Unnamed Unit'}</label>
                        </div>
                    `;
                });
                unitListDiv.innerHTML = html;
                reviveConfirmBtn.disabled = true;

                unitListDiv.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.addEventListener('change', () => {
                        reviveConfirmBtn.disabled = !unitListDiv.querySelector('input[name="unit-to-revive"]:checked');
                    });
                });
            }

            modal.style.display = 'flex';
            
            document.getElementById('revive-unit-confirm-btn').onclick = reviveSelectedUnit;
            document.getElementById('revive-unit-cancel-btn').onclick = hideReviveUnitModal;
        }

        function hideReviveUnitModal() {
            document.getElementById('revive-unit-modal').style.display = 'none';
        }

        function reviveSelectedUnit() {
            const selectedUnitId = document.querySelector('#revive-unit-list input[name="unit-to-revive"]:checked')?.value;
            if (!selectedUnitId) {
                showNotification('Please select a unit to revive.', 'warning');
                return;
            }
            const unitId = parseInt(selectedUnitId);
            const unitToRevive = crusadeData.units.find(u => u.id === unitId);

            if (!unitToRevive) {
                showNotification('Selected unit not found.', 'error');
                return;
            }

            const cost = 1; // Combat Revival cost is 1 RP
            if (deductArmyRP(cost, `Combat Revival for unit "${unitToRevive.name}"`, unitId)) {
                unitToRevive.status = 'active';
                addBattleScar('Revival Scars', 'Resurrected', unitId);
                
                hideReviveUnitModal();
                renderUnitsGrid();
                updateArmyStats();
                selectUnit(unitId);
                switchTab('progress');
                autoSave();
                showNotification(`${unitToRevive.name} has been successfully revived!`, 'success');
            }
        }

        // --- Out of Action Roll Modal Functions ---
        let currentOOAUnitId = null;

        function showOutOfActionPrompt(unitId) {
            currentOOAUnitId = unitId;
            const unit = crusadeData.units.find(u => u.id === unitId);
            if (!unit) return;

            document.getElementById('ooa-unit-name').textContent = unit.name || 'Unnamed Unit';
            document.getElementById('ooa-dice-roll').value = '';
            document.getElementById('ooa-roll-modal').style.display = 'flex';

            document.getElementById('ooa-apply-btn').onclick = applyOOAResultFromModal;
            document.getElementById('ooa-cancel-btn').onclick = hideOutOfActionPrompt;
        }

        function hideOutOfActionPrompt() {
            document.getElementById('ooa-roll-modal').style.display = 'none';
            currentOOAUnitId = null;
        }

        function applyOOAResultFromModal() {
            const roll = parseInt(document.getElementById('ooa-dice-roll').value);
            if (isNaN(roll) || roll < 1 || roll > 6) {
                showNotification('Please enter a valid D6 roll (1-6).', 'warning');
                return;
            }
            applyOutOfActionResult(currentOOAUnitId, roll);
            hideOutOfActionPrompt();
        }

        function applyOutOfActionResult(unitId, roll) {
            const unit = crusadeData.units.find(u => u.id === unitId);
            if (!unit || unit.status === 'destroyed') {
                showNotification('Cannot apply Out of Action result to a destroyed unit.', 'warning');
                return;
            }

            const result = outOfActionResults[roll];
            if (!result) {
                showNotification('Invalid Out of Action roll result.', 'error');
                return;
            }

            let message = `${unit.name} rolled a ${roll} for Out of Action: ${result.description}`;

            if (result.xp > 0) {
                applyXPToUnit(unit.id, result.xp);
                message += ` (+${result.xp} XP)`;
            }

            if (result.scar) {
                const scarCategory = result.scar.category;
                const scarName = result.scar.name;
                addBattleScar(scarCategory, scarName, unit.id); // Call addBattleScar with direct arguments
                message += ` and gained "${scarName}" scar.`;
            }

            unit.notes = (unit.notes ? unit.notes + '\n' : '') + `Out of Action Roll (${new Date().toLocaleDateString()}): Rolled ${roll}. Result: ${result.description}`;

            renderUnitProgress();
            renderUnitTraits();
            renderUnitsGrid();
            updateArmyStats();
            autoSave();
            showNotification(message, 'success');
        }

        function exportData() {
            try {
                const gameName = prompt('Enter a name for the exported file:', crusadeData.armyName || 'My Crusade Force');
                if (!gameName) return;
                
                const exportObject = {
                    units: crusadeData.units,
                    currentUnitId: crusadeData.currentUnitId,
                    nextUnitId: crusadeData.nextUnitId,
                    armyName: crusadeData.armyName,
                    supplyLimitPoints: crusadeData.supplyLimitPoints,
                    crusadeLevel: crusadeData.crusadeLevel,
                    requisitionPoints: crusadeData.requisitionPoints,
                    crusadeLog: crusadeData.crusadeLog,
                    warlord: crusadeData.warlord,
                    rpLedger: crusadeData.rpLedger,
                    crusadeAgendas: crusadeData.crusadeAgendas,
                    trackByPoints: crusadeData.trackByPoints, // Export new setting
                    pointsPerPowerLevel: crusadeData.pointsPerPowerLevel, // Export new setting
                    exportedAt: new Date().toISOString(),
                    version: '7.0' // Increment version for this significant change
                };
                
                const dataStr = JSON.stringify(exportObject, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = gameName.replace(/[^a-z0-9]/gi, '_') + '.json';
                link.click();
                
                showNotification('Data exported successfully!', 'success');
                
            } catch (error) {
                console.error('Error exporting data:', error);
                showNotification('Error exporting data: ' + error.message, 'error');
            }
        }

        function importData() {
            try {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                const importedData = JSON.parse(e.target.result);
                                
                                if (importedData.units) {
                                    if (confirm('Import this data? This will replace your current crusade.')) {
                                        crusadeData.units = importedData.units || [];
                                        crusadeData.armyName = importedData.armyName || 'Imported Army';
                                        crusadeData.supplyLimitPoints = importedData.supplyLimitPoints || 50;
                                        crusadeData.crusadeLevel = importedData.crusadeLevel || 'Incursion';
                                        crusadeData.requisitionPoints = importedData.requisitionPoints || 5;
                                        crusadeData.crusadeLog = importedData.crusadeLog || [];
                                        crusadeData.warlord = importedData.warlord || null;
                                        crusadeData.rpLedger = importedData.rpLedger || [];
                                        crusadeData.crusadeAgendas = importedData.crusadeAgendas || [];
                                        crusadeData.trackByPoints = importedData.trackByPoints !== undefined ? importedData.trackByPoints : true; // Import new setting, default to true
                                        crusadeData.pointsPerPowerLevel = importedData.pointsPerPowerLevel || 20; // Import new setting, default to 20
                                        
                                        let maxUnitId = 0;
                                        crusadeData.units.forEach(function(unit) {
                                            if (unit.id > maxUnitId) maxUnitId = unit.id; // Corrected: maxId to maxUnitId
                                            unit.battleTraits = unit.battleTraits || [];
                                            unit.battleScars = unit.battleScars || [];
                                            unit.agendas = unit.agendas || [];
                                            unit.unitType = unit.unitType || 'Troops';
                                            unit.powerLevel = parseInt(unit.powerLevel) || 0;
                                            unit.pointsCost = parseInt(unit.pointsCost) || 0; // Ensure pointsCost is a number
                                            unit.models = parseInt(unit.models) || 5;
                                            unit.crusadeRank = getCrusadeRank(unit.xp || 0).name;
                                            unit.rangedWeapons = unit.rangedWeapons || [];
                                            unit.meleeWeapons = unit.meleeWeapons || [];
                                            unit.battlesPlayed = parseInt(unit.battlesPlayed) || 0;
                                            unit.battlesWon = parseInt(unit.battlesWon) || 0;
                                            unit.battlesSurvived = parseInt(unit.battlesSurvived) || 0;
                                            unit.enemiesDestroyed = parseInt(unit.enemiesDestroyed) || 0;
                                            unit.psychicPowersManifested = parseInt(unit.psychicPowersManifested) || 0;
                                            unit.honors = unit.honors || '';
                                            unit.scars = unit.scars || '';
                                            unit.notes = unit.notes || '';
                                            unit.leadership = parseInt(unit.leadership) || 7;
                                            unit.movement = parseInt(unit.movement) || 6;
                                            unit.toughness = parseInt(unit.toughness) || 4;
                                            unit.wounds = parseInt(unit.wounds) || 1;
                                            unit.save = unit.save || '3+';
                                            unit.isWarlord = unit.isWarlord || false;
                                            unit.warlordTrait = unit.warlordTrait || null;
                                            unit.crusadeRelic = unit.crusadeRelic || null;
                                            unit.status = unit.status || 'active';
                                            unit.xp = parseInt(unit.xp) || 0; // Ensure XP is always a number
                                        });
                                        
                                        crusadeData.nextUnitId = maxUnitId + 1;
                                        crusadeData.currentUnitId = null;
                                        
                                        renderUnitsGrid();
                                        updateArmyStats();
                                        clearUnitViews();
                                        renderCrusadeLog();
                                        renderRPLedger();
                                        renderAgendasTab(); // Re-render agendas tab on import
                                        
                                        const activeUnits = crusadeData.units.filter(u => u.status === 'active');
                                        if (activeUnits.length > 0) {
                                            selectUnit(activeUnits[0].id);
                                            switchTab('details');
                                        } else {
                                            switchTab('units');
                                        }
                                        autoSave();
                                        
                                        showNotification('Data imported successfully!', 'success');
                                    }
                                } else {
                                    showNotification('Invalid file format. Please import a valid Crusade Tracker JSON file.', 'error');
                                }
                            } catch (error) {
                                console.error('Error parsing imported file:', error);
                                showNotification('Error importing file: ' + error.message, 'error');
                            }
                        };
                        reader.readAsText(file);
                    }
                });
                input.click();
            } catch (error) {
                console.error("Error initiating import:", error);
                showNotification('Error initiating import.', 'error');
            }
        }

        function saveData() {
            try {
                const gameName = prompt('Enter a name for this save:', crusadeData.armyName || 'My Crusade Force');
                if (!gameName) return;
                
                const saveObject = {
                    units: crusadeData.units,
                    currentUnitId: crusadeData.currentUnitId,
                    nextUnitId: crusadeData.nextUnitId,
                    armyName: crusadeData.armyName,
                    supplyLimitPoints: crusadeData.supplyLimitPoints,
                    crusadeLevel: crusadeData.crusadeLevel,
                    requisitionPoints: crusadeData.requisitionPoints,
                    crusadeLog: crusadeData.crusadeLog,
                    warlord: crusadeData.warlord,
                    rpLedger: crusadeData.rpLedger,
                    crusadeAgendas: crusadeData.crusadeAgendas,
                    trackByPoints: crusadeData.trackByPoints, // Save new setting
                    pointsPerPowerLevel: crusadeData.pointsPerPowerLevel, // Save new setting
                    savedAt: new Date().toISOString(),
                    version: '7.0' // Increment version for this significant change
                };
                
                const existingSaves = JSON.parse(localStorage.getItem('crusadeSaves') || '{}');
                existingSaves[gameName] = saveObject;
                localStorage.setItem('crusadeSaves', JSON.stringify(existingSaves));
                
                showNotification('Game "' + gameName + '" saved successfully!', 'success');
                
            } catch (error) {
                console.error('Error saving game:', error);
                showNotification('Error saving game: ' + error.message, 'error');
            }
        }

        function loadData() {
            try {
                const existingSaves = JSON.parse(localStorage.getItem('crusadeSaves') || '{}');
                const saveNames = Object.keys(existingSaves);
                
                if (saveNames.length === 0) {
                    showNotification('No saved games found.', 'info');
                    return;
                }
                
                let saveList = 'Choose a game to load:\n\n';
                saveNames.forEach(function(name, i) {
                    const save = existingSaves[name];
                    saveList += (i + 1) + '. ' + name + ' (v' + (save.version || '1.0') + ', ' + (save.units ? save.units.length : 0) + ' units, ' + new Date(save.savedAt).toLocaleDateString() + ')\n';
                });
                
                const choice = prompt(saveList + '\nEnter the number to load:');
                if (!choice) return;
                
                const choiceIndex = parseInt(choice) - 1;
                if (isNaN(choiceIndex) || choiceIndex < 0 || choiceIndex >= saveNames.length) {
                    showNotification('Invalid choice.', 'error');
                    return;
                }
                
                const selectedSave = existingSaves[saveNames[choiceIndex]];
                
                crusadeData.units = selectedSave.units || [];
                crusadeData.currentUnitId = selectedSave.currentUnitId;
                crusadeData.nextUnitId = selectedSave.nextUnitId || 1;
                crusadeData.armyName = selectedSave.armyName || 'My Crusade Force';
                crusadeData.supplyLimitPoints = selectedSave.supplyLimitPoints || 50;
                crusadeData.crusadeLevel = selectedSave.crusadeLevel || 'Incursion';
                crusadeData.requisitionPoints = selectedSave.requisitionPoints || 5;
                crusadeData.crusadeLog = selectedSave.crusadeLog || [];
                crusadeData.warlord = selectedSave.warlord || null;
                crusadeData.rpLedger = selectedSave.rpLedger || [];
                crusadeData.crusadeAgendas = selectedSave.crusadeAgendas || [];
                crusadeData.trackByPoints = selectedSave.trackByPoints !== undefined ? selectedSave.trackByPoints : true; // Load new setting, default to true
                crusadeData.pointsPerPowerLevel = selectedSave.pointsPerPowerLevel || 20; // Load new setting, default to 20


                crusadeData.units.forEach(function(unit) {
                    unit.battleTraits = unit.battleTraits || [];
                    unit.battleScars = unit.battleScars || [];
                    unit.agendas = unit.agendas || [];
                    unit.unitType = unit.unitType || 'Troops';
                    unit.powerLevel = parseInt(unit.powerLevel) || 0;
                    unit.pointsCost = parseInt(unit.pointsCost) || 0;
                    unit.models = parseInt(unit.models) || 5;
                    unit.crusadeRank = getCrusadeRank(unit.xp || 0).name;
                    unit.rangedWeapons = unit.rangedWeapons || [];
                    unit.meleeWeapons = unit.meleeWeapons || [];
                    unit.battlesPlayed = parseInt(unit.battlesPlayed) || 0;
                    unit.battlesWon = parseInt(unit.battlesWon) || 0;
                    unit.battlesSurvived = parseInt(unit.battlesSurvived) || 0;
                    unit.enemiesDestroyed = parseInt(unit.enemiesDestroyed) || 0;
                    unit.psychicPowersManifested = parseInt(unit.psychicPowersManifested) || 0;
                    unit.honors = unit.honors || '';
                    unit.scars = unit.scars || '';
                    unit.notes = unit.notes || '';
                    unit.leadership = parseInt(unit.leadership) || 7;
                    unit.movement = parseInt(unit.movement) || 6;
                    // Ensure removed fields from details tab still exist for printing/weapons
                    unit.weaponSkill = unit.weaponSkill || '';
                    unit.ballisticSkill = unit.ballisticSkill || '';
                    unit.strength = unit.strength || 0;
                    unit.attacks = unit.attacks || 0;
                    unit.toughness = parseInt(unit.toughness) || 4;
                    unit.wounds = parseInt(unit.wounds) || 1;
                    unit.save = unit.save || '3+';
                    unit.isWarlord = unit.isWarlord || false;
                    unit.warlordTrait = unit.warlordTrait || null;
                    unit.crusadeRelic = unit.crusadeRelic || null;
                    unit.status = unit.status || 'active';
                    unit.xp = parseInt(unit.xp) || 0;
                });
                
                renderUnitsGrid();
                updateArmyStats();
                renderCrusadeLog();
                renderRPLedger();
                renderAgendasTab();
                
                const activeUnits = crusadeData.units.filter(u => u.status === 'active');
                if (activeUnits.length > 0) {
                    const initialSelectId = crusadeData.currentUnitId;
                    const foundInitialUnit = activeUnits.find(u => u.id === initialSelectId);
                    if (foundInitialUnit) {
                        selectUnit(initialSelectId);
                        //switchTab('details');
                    } else if (activeUnits.length > 0) {
                        selectUnit(activeUnits[0].id);
                        //switchTab('details');
                    }
                } else {
                    clearUnitViews();
                    switchTab('units');
                }
                
                showNotification('Game "' + saveNames[choiceIndex] + '" loaded successfully!', 'success');
                switchTab('units');  // Force switch to units tab after loading is complete
            } catch (error) {
                console.error('Error loading game:', error);
                showNotification('Error loading game: ' + error.message, 'error');
            }
        }

        function printUnit() {
            try {
                const currentUnit = getCurrentUnit();
                if (!currentUnit) {
                    showNotification('Please select a unit to print.', 'error');
                    return;
                }
                
                const rank = getCrusadeRank(currentUnit.xp || 0);
                
                let printContent = '<!DOCTYPE html><html><head>';
                printContent += '<title>' + (currentUnit.name || 'Unit') + ' - Crusade Unit Sheet</title>';
                printContent += '<style>';
                printContent += 'body { font-family: Arial, sans-serif; margin: 15px; color: black; line-height: 1.6; }';
                printContent += 'h1, h2, h3 { color: #333; margin-top: 15px; margin-bottom: 5px; }';
                printContent += 'strong { color: #555; }';
                printContent += '.header { text-align: center; border-bottom: 2px solid #000; margin-bottom: 20px; padding-bottom: 10px; }';
                printContent += '.section-header { border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px; }';
                printContent += '.stats-grid, .weapon-grid-print { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px; }';
                printContent += '.stat-item, .weapon-item-print { border: 1px solid #ddd; padding: 8px; border-radius: 4px; background: #fdfdfd; }';
                printContent += '.weapon-table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 0.9em; }';
                printContent += '.weapon-table th, .weapon-table td { border: 1px solid #ccc; padding: 6px; text-align: left; }';
                printContent += '.weapon-table th { background: #eee; }';
                printContent += '.notes-section, .traits-section-print { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }';
                printContent += '.trait-item-print { background: #f5f5f5; border: 1px solid #ddd; padding: 8px; margin-bottom: 5px; border-radius: 4px; }';
                printContent += '.trait-name-print { font-weight: bold; color: #333; }';
                printContent += '.trait-description-print { font-size: 0.85em; color: #666; }';
                printContent += '</style></head><body>';
                
                printContent += '<div class="header">';
                printContent += '<h1>' + (currentUnit.name || 'Unnamed Unit') + '</h1>';
                const factionDisplay = currentUnit.subfaction ? `${currentUnit.subfaction} (${currentUnit.faction || 'Unknown Faction'})` : (currentUnit.faction || 'Unknown Faction');
                printContent += `<div>${factionDisplay} - ${currentUnit.unitType || 'Unknown Type'}${currentUnit.isWarlord ? ' (Army Warlord)' : ''}</div>`;
                printContent += `<div>${rank.name} (${currentUnit.xp || 0} XP)</div>`;
                printContent += `<div>Status: <strong>${currentUnit.status.toUpperCase()}</strong></div>`;
                printContent += '</div>';
                
                printContent += '<h2>Basic Information</h2>';
                printContent += '<div class="stats-grid">';
                printContent += `<div class="stat-item"><strong>Crusade Points:</strong> ${currentUnit.pointsCost || 0}</div>`;
                printContent += `<div class="stat-item"><strong>Power Level:</strong> ${currentUnit.powerLevel || 0}</div>`;
                printContent += `<div class="stat-item"><strong>Models:</strong> ${currentUnit.models || 1}</div>`;
                printContent += `<div class="stat-item"><strong>Battles Fought:</strong> ${currentUnit.battlesPlayed || 0}</div>`;
                printContent += `<div class="stat-item"><strong>Battles Won:</strong> ${currentUnit.battlesWon || 0}</div>`;
                printContent += `<div class="stat-item"><strong>Battles Survived:</strong> ${currentUnit.battlesSurvived || 0}</div>`;
                printContent += `<div class="stat-item"><strong>Enemies Destroyed:</strong> ${currentUnit.enemiesDestroyed || 0}</div>`;
                printContent += `<div class="stat-item"><strong>Psychic Powers:</strong> ${currentUnit.psychicPowersManifested || 0}</div>`;
                printContent += '</div>';

                printContent += '<h2>Unit Characteristics</h2>';
                printContent += '<table class="weapon-table">';
                printContent += '<thead><tr><th>M</th><th>T</th><th>W</th><th>Ld</th><th>Save</th></tr></thead>';
                printContent += '<tbody><tr>';
                printContent += `<td>${currentUnit.movement || 6}"</td>`;
                printContent += `<td>${currentUnit.toughness || 4}</td>`;
                printContent += `<td>${currentUnit.wounds || 1}</td>`;
                printContent += `<td>${currentUnit.leadership || 7}</td>`;
                printContent += `<td>${currentUnit.save || '3+'}</td>`;
                printContent += '</tr></tbody></table>';
                
                printContent += '<h2>Weapons</h2>';
                if ((currentUnit.rangedWeapons && currentUnit.rangedWeapons.length > 0) || (currentUnit.meleeWeapons && currentUnit.meleeWeapons.length > 0)) {
                    printContent += '<h3>Ranged Weapons</h3>';
                    if (currentUnit.rangedWeapons && currentUnit.rangedWeapons.length > 0) {
                        currentUnit.rangedWeapons.forEach(weapon => {
                            printContent += '<div class="weapon-item-print">';
                            printContent += `<strong>${weapon.name || 'Unnamed Ranged Weapon'}</strong><br>`;
                            printContent += `Range: ${weapon.range || 'N/A'}, Attacks: ${weapon.attacks || 'N/A'}, BS: ${weapon.bs || 'N/A'}, S: ${weapon.strength || 'N/A'}, AP: ${weapon.ap || 'N/A'}, D: ${weapon.damage || 'N/A'}<br>`;
                            printContent += `Abilities: ${weapon.abilities || 'None'}`;
                            printContent += '</div>';
                        });
                    } else {
                        printContent += '<p>No ranged weapons.</p>';
                    }

                    printContent += '<h3>Melee Weapons</h3>';
                    if (currentUnit.meleeWeapons && currentUnit.meleeWeapons.length > 0) {
                        currentUnit.meleeWeapons.forEach(weapon => {
                            printContent += '<div class="weapon-item-print">';
                            printContent += `<strong>${weapon.name || 'Unnamed Melee Weapon'}</strong><br>`;
                            printContent += `WS: ${weapon.ws || 'N/A'}, Attacks: ${weapon.attacks || 'N/A'}, S: ${weapon.strength || 'N/A'}, AP: ${weapon.ap || 'N/A'}, D: ${weapon.damage || 'N/A'}<br>`;
                            printContent += `Abilities: ${weapon.abilities || 'None'}`;
                            printContent += '</div>';
                        });
                    } else {
                        printContent += '<p>No melee weapons.</p>';
                    }
                } else {
                    printContent += '<p>No weapons assigned.</p>';
                }

                if (currentUnit.isWarlord) {
                    printContent += '<h2>Warlord Details</h2>';
                    printContent += '<div class="traits-section-print">';
                    if (currentUnit.warlordTrait) {
                        const traitDetail = findTraitDetail(currentUnit.warlordTrait.name);
                        printContent += '<h3>Warlord Trait:</h3>';
                        printContent += '<div class="trait-item-print">';
                        printContent += `<div class="trait-name-print">${currentUnit.warlordTrait.name} (Cost: ${currentUnit.warlordTrait.cost || 0} RP)</div>`;
                        printContent += `<div class="trait-description-print">${traitDetail ? traitDetail.description : 'Description not found.'}</div>`;
                        printContent += '</div>';
                    } else {
                        printContent += '<p>No Warlord Trait assigned.</p>';
                    }
                    if (currentUnit.crusadeRelic) {
                        const relicDetail = findRelicDetail(currentUnit.crusadeRelic.name);
                        printContent += '<h3>Crusade Relic:</h3>';
                        printContent += '<div class="trait-item-print">';
                        printContent += `<div class="trait-name-print">${currentUnit.crusadeRelic.name} (Cost: ${currentUnit.crusadeRelic.cost || 0} RP)</div>`;
                        printContent += `<div class="trait-description-print">${relicDetail ? relicDetail.description : 'Description not found.'}</div>`;
                        printContent += '</div>';
                    }
                    else {
                        printContent += '<p>No Crusade Relic assigned.</p>';
                    }
                    printContent += '</div>';
                }

                printContent += '<div class="traits-section-print">';
                printContent += '<h2>Battle Traits</h2>';
                if (currentUnit.battleTraits && currentUnit.battleTraits.length > 0) {
                    currentUnit.battleTraits.forEach(trait => {
                        // Use the description from the trait object if it was manually added, otherwise fallback to predefined.
                        const traitDetail = crusadeTraits[trait.category]?.[trait.name];
                        const descriptionToPrint = traitDetail ? traitDetail.description : (trait.description || 'Manually added entry.');
                        printContent += '<div class="trait-item-print">';
                        printContent += `<div class="trait-name-print">${trait.name} (Cost: ${trait.cost || 0} RP)</div>`;
                        if (trait.category) { // Show category for custom traits
                           printContent += `<div class="trait-description-print">Category: ${trait.category}</div>`;
                        }
                        printContent += `<div class="trait-description-print">${descriptionToPrint}</div>`;
                        printContent += '</div>';
                    });
                } else {
                    printContent += '<p>No battle traits.</p>';
                }
                printContent += '</div>';

                printContent += '<div class="traits-section-print">';
                printContent += '<h2>Battle Scars</h2>';
                if (currentUnit.battleScars && currentUnit.battleScars.length > 0) {
                    currentUnit.battleScars.forEach(scar => {
                        // Use the description from the scar object if it was manually added, otherwise fallback to predefined.
                        const scarDetail = battleScars[scar.category]?.[scar.name];
                        const descriptionToPrint = scarDetail ? scarDetail.description : (scar.description || 'Manually added entry.');
                        printContent += '<div class="trait-item-print">';
                        printContent += `<div class="trait-name-print">${scar.name}</div>`;
                        if (scar.category) { // Show category for custom scars
                            printContent += `<div class="trait-description-print">Category: ${scar.category}</div>`;
                        }
                        printContent += `<div class="trait-description-print">${descriptionToPrint}</div>`;
                        printContent += '</div>';
                    });
                } else {
                    printContent += '<p>No battle scars.</p>';
                }
                printContent += '</div>';

                // Print Assigned Agendas (new section)
                if (currentUnit.agendas && currentUnit.agendas.length > 0) {
                    printContent += '<div class="traits-section-print">';
                    printContent += '<h2>Assigned Agendas</h2>';
                    currentUnit.agendas.forEach(agendaName => {
                        const agendaDetail = crusadeData.crusadeAgendas.find(a => a.name === agendaName);
                        if (agendaDetail) {
                            printContent += '<div class="trait-item-print">';
                            printContent += `<div class="trait-name-print">${agendaDetail.name} (Reward: ${agendaDetail.xp} XP)</div>`;
                            printContent += `<div class="trait-description-print">${agendaDetail.description}</div>`;
                            printContent += '</div>';
                        }
                    });
                } else {
                    printContent += '<div class="traits-section-print"><p>No agendas assigned to this unit.</p></div>';
                }

                printContent += '<div class="notes-section">';
                printContent += '<h2>Honors & Scars (Text)</h2>';
                printContent += `<h3>Battle Honors:</h3><p>${currentUnit.honors || 'No honors recorded.'}</p>`;
                printContent += `<h3>Battle Scars (Text):</h3><p>${currentUnit.scars || 'No scars recorded.'}</p>`;
                printContent += '</div>';

                printContent += '<div class="notes-section">';
                printContent += '<h2>General Notes</h2>';
                printContent += `<p>${currentUnit.notes || 'No additional notes.'}</p>`;
                printContent += '</div>';

                printContent += '</body></html>';
                
                const printWindow = window.open('', '_blank', 'width=900,height=700');
                if (printWindow) {
                    printWindow.document.open();
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    printWindow.focus();
                    printWindow.print();
                    showNotification('Unit sheet opened for printing!', 'success');
                } else {
                    showNotification('Print blocked by browser. Please allow popups.', 'warning');
                }
            } catch (error) {
                console.error('Print failed. Error:', error);
                showNotification('Print failed. Error: ' + error.message, 'error');
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000; padding: 1rem 1.5rem; border-radius: 8px; color: white; font-weight: bold; max-width: 300px; opacity: 0; transition: opacity 0.3s ease;';
            
            switch(type) {
                case 'success': notification.style.background = 'linear-gradient(135deg, #10b981, #059669)'; break;
                case 'error': notification.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)'; break;
                case 'warning': notification.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)'; break;
                default: notification.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => { notification.style.opacity = '1'; }, 100);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => { if (notification.parentNode) notification.parentNode.removeChild(notification); }, 300);
            }, 3000);
        }

        function autoSave() {
            try {
                localStorage.setItem('crusadeDataAutoSave', JSON.stringify(crusadeData));
            } catch (error) {
                console.error('Auto-save failed:', error);
            }
        }

        function initializeApp() {
            try {
                const autoSavedData = localStorage.getItem('crusadeDataAutoSave');
                if (autoSavedData) {
                    const loadedData = JSON.parse(autoSavedData);
                    crusadeData = {
                        ...crusadeData, // Keep defaults for properties that might be missing
                        ...loadedData,
                    };
                    
                    crusadeData.units.forEach(function(unit) {
                        unit.battleTraits = unit.battleTraits || [];
                        unit.battleScars = unit.battleScars || [];
                        unit.unitType = unit.unitType || 'Troops';
                        unit.agendas = unit.agendas || [];
                        unit.status = unit.status || 'active';
                        // Ensure numerical fields are parsed correctly during load for older saves
                        unit.xp = parseInt(unit.xp) || 0;
                        unit.powerLevel = parseInt(unit.powerLevel) || 0;
                        unit.pointsCost = parseInt(unit.pointsCost) || 0;
                        unit.battlesPlayed = parseInt(unit.battlesPlayed) || 0;
                        unit.battlesWon = parseInt(unit.battlesWon) || 0;
                        unit.battlesSurvived = parseInt(unit.battlesSurvived) || 0;
                        unit.enemiesDestroyed = parseInt(unit.enemiesDestroyed) || 0;
                        unit.psychicPowersManifested = parseInt(unit.psychicPowersManifested) || 0;
                        unit.models = parseInt(unit.models) || 5;
                        unit.leadership = parseInt(unit.leadership) || 7;
                        unit.movement = parseInt(unit.movement) || 6;
                        unit.toughness = parseInt(unit.toughness) || 4;
                        unit.wounds = parseInt(unit.wounds) || 1;
                        unit.save = unit.save || '3+';
                    });
                    
                    const maxId = crusadeData.units.reduce((max, unit) => Math.max(max, unit.id), 0);
                    crusadeData.nextUnitId = maxId + 1;

                } else {
                    crusadeData.rpLedger.push({
                        id: generateLedgerId(), date: new Date().toISOString().slice(0, 10), type: 'gain', amount: crusadeData.requisitionPoints,
                        description: 'Initial Requisition Points', unitId: null, balanceAfter: crusadeData.requisitionPoints
                    });
                    crusadeData.crusadeAgendas.push({ name: 'Assassinate', xp: 3, description: 'Destroy a specific enemy CHARACTER unit.' });
                    crusadeData.crusadeAgendas.push({ name: 'Linebreaker', xp: 2, description: 'Have at least one model from this unit wholly within the enemy deployment zone at the end of the battle.' });
                    crusadeData.crusadeAgendas.push({ name: 'Hold the Line', xp: 2, description: 'Ensure no enemy units are within your own deployment zone at the end of the battle.' });
                }
                
                renderUnitsGrid();
                updateArmyStats();
                clearUnitViews();
                renderCrusadeLog();
                renderRPLedger();
                renderAgendaTrackingForBattle();

                switchTab('units');

                if (crusadeData.units.length > 0) {
                    const activeUnits = crusadeData.units.filter(u => u.status === 'active');
                    const initialSelectId = crusadeData.currentUnitId;
                    const foundInitialUnit = activeUnits.find(u => u.id === initialSelectId);
                    if (foundInitialUnit) {
                        selectUnit(initialSelectId);
                        switchTab('details');
                    } else if (activeUnits.length > 0) {
                        selectUnit(activeUnits[0].id);
                        switchTab('details');
                    }
                } else {
                    setTimeout(() => showNotification('Welcome! Click "‚ûï New Unit" to begin.', 'info'), 1000);
                }

                document.querySelectorAll('.tabs .tab').forEach(button => {
                    button.addEventListener('click', function() { switchTab(this.dataset.tab); });
                });

                document.getElementById('create-new-unit-btn').addEventListener('click', createNewUnit);
                document.getElementById('export-data-btn').addEventListener('click', exportData);
                document.getElementById('import-data-btn').addEventListener('click', importData);
                document.getElementById('save-data-btn').addEventListener('click', saveData);
                document.getElementById('load-data-btn').addEventListener('click', loadData);
                document.getElementById('print-unit-btn').addEventListener('click', printUnit);
                document.getElementById('add-new-unit-bottom-btn').addEventListener('click', createNewUnit);

                document.getElementById('army-name-input').addEventListener('change', function() { updateArmySettings('armyName', this.value); });
                document.getElementById('crusade-level-select').addEventListener('change', function() { updateArmySettings('crusadeLevel', this.value); });
                document.getElementById('army-rp-input').addEventListener('change', function() { updateArmySettings('requisitionPoints', this.value); });
                
                // NEW: Toggle for tracking mode
                document.getElementById('tracking-mode-toggle').addEventListener('change', toggleTrackingMode);
                document.getElementById('tracking-mode-toggle').checked = !crusadeData.trackByPoints; // Initialize the toggle state

                document.getElementById('add-new-agenda-btn').addEventListener('click', addNewAgenda);
                document.getElementById('record-battle-btn').addEventListener('click', recordBattle);
                document.getElementById('log-date').value = new Date().toISOString().slice(0, 10);

            } catch (error) {
                console.error('Initialization failed:', error);
                showNotification('Application failed to load: ' + error.message, 'error');
            }
        }

        setInterval(autoSave, 30000);

        window.addEventListener('load', initializeApp);
        window.addEventListener('beforeunload', function() {
            autoSave();
        });
    </script>
</body>
</html>
